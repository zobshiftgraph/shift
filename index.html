<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Graph</title>
    <style>
        :root { 
            --primary: #2c3e50; 
            --accent: #72b5f6; 
            --bg: #f8f9fa; 
            --leave: rgba(100, 100, 100, 0.8); 
            --xte: #d4f7d4; 
            --handover: rgba(255, 242, 0, 0.7); 
            --border: #dee2e6;
            --inactive: #bdc3c7; 
            --now: #e74c3c;
            --draft-color: #9b59b6;
            --trainee: #d1b3ff; 
        }
        
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background-color: #e9ecef; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        header { background: var(--primary); color: white; padding: 0.4rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; font-size: 13px; height: 35px; }
        #bigDraftWarning { display: none; position: absolute; left: 50%; transform: translateX(-50%); color: #ff3e3e; font-size: 24px; font-weight: 900; letter-spacing: 5px; pointer-events: none; z-index: 100; }
        
        .main-layout { display: flex; flex: 1; overflow: hidden; padding: 5px; gap: 5px; min-height: 0; }
        .work-area { flex: 3; display: flex; flex-direction: column; gap: 5px; min-width: 0; height: 100%; }
        
        .timeline-container { background: white; border-radius: 4px; border: 1px solid var(--border); box-shadow: 0 1px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        .timeline-container.is-draft-mode { border: 4px solid #e74c3c !important; }
        
        .scrollable-timeline { overflow-x: hidden; overflow-y: auto; flex: 1; position: relative; width: 100%; display: flex; flex-direction: column; }
        .grid-wrapper { position: relative; width: 100%; display: flex; flex-direction: column; flex: 1; min-height: 0; }
        
        /* 24 COLUMNS */
        .labels { display: grid; grid-template-columns: repeat(24, 1fr); background: #f1f3f5; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 20; flex-shrink: 0; width: 100%; }
        .hour-label { font-size: 9px; text-align: center; padding: 2px 0; transform: translateX(-50%); white-space: nowrap; overflow: hidden; }
        
        .capacity-row { display: grid; grid-template-columns: repeat(24, 1fr); width: 100%; background: #fffbe6; border-bottom: 2px solid var(--border); font-weight: bold; position: sticky; top: 17px; z-index: 20; flex-shrink: 0; }
        .cap-cell { font-size: 9px; text-align: center; padding: 2px 0; border-right: 1px solid #dee2e6; }
        
        .chart-area { 
            position: relative; width: 100%; flex: 1; 
            display: flex; flex-direction: column; 
            background-image: linear-gradient(to right, #f1f3f5 1px, transparent 1px); 
            background-size: calc(100% / 24) 100%; 
            overflow-y: auto; overflow-x: hidden;
        }
        
        #nowLine { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--now); z-index: 30; pointer-events: none; }
        
        /* --- ROW STYLING --- */
        .shift-row { 
            position: relative; width: 100%; 
            /* Fixed Compact Height: 30px row for 25px bar leaves 2.5px margin */
            height: 30px; 
            border-bottom: 1px solid #e9ecef; flex-shrink: 0; 
        }
        
        /* --- BAR STYLING (25px) --- */
        .shift-bar { 
            position: absolute; height: 25px; 
            top: 50%; transform: translateY(-50%); /* Center Vertically */
            background: var(--accent); color: #000; border-radius: 3px; 
            font-size: 10px; font-weight: bold; white-space: nowrap; 
            box-sizing: border-box; box-shadow: 1px 1px 2px rgba(0,0,0,0.15); 
            z-index: 2; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        
        .shift-bar.trainee-bar { background: var(--trainee); } 
        .shift-bar.inactive-bar { background-color: var(--inactive) !important; color: #7f8c8d !important; box-shadow: none; }
        .bar-text { z-index: 10; pointer-events: none; padding: 0 2px; text-shadow: 0 0 2px rgba(255,255,255,0.5); }

        /* OVERLAYS */
        .training-overlap-overlay { 
            position: absolute; height: 100%; top: 0; z-index: 4; pointer-events: none;
            background: repeating-linear-gradient(45deg, var(--accent), var(--accent) 10px, var(--trainee) 10px, var(--trainee) 20px);
            opacity: 0.6;
        }
        .handover-overlay { position: absolute; height: 100%; top:0; background: var(--handover); z-index: 5; pointer-events: none; }
        .leave-overlay { position: absolute; height: 100%; top: 0; z-index: 6; pointer-events: none; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 900; background: var(--leave); color: white; }
        .xte-overlay { position: absolute; height: 100%; top: 0; z-index: 7; pointer-events: none; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 900; background: var(--xte); color: black; }
        .preview-highlight { outline: 2px solid #2ecc71 !important; box-shadow: 0 0 10px #2ecc71 !important; z-index: 100 !important; }
        .preview-original-dashed { outline: 2px dashed #7f8c8d !important; outline-offset: -2px; }

        .guidance-bar { background: #ffffff; border-bottom: 1px solid var(--border); padding: 4px 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; font-size: 10px; font-weight: bold; flex-shrink: 0; min-height: 24px;}
        .guidance-section { display: flex; align-items: center; gap: 8px; border-right: 2px solid #ddd; padding-right: 15px; }
        .blue-shift { color: #3498db; font-weight: bold; }
        .day-sup-container { display: flex; align-items: center; gap: 4px; margin-left: 10px; cursor: pointer; }

        .controls { background: white; padding: 5px; border-radius: 4px; display: grid; grid-template-columns: auto auto auto auto auto auto 1fr auto auto auto; gap: 5px; align-items: end; flex-shrink: 0; font-size: 10px; }
        .input-group { display: flex; flex-direction: column; gap: 1px; }
        label { font-size: 9px; font-weight: bold; text-transform: uppercase; color: #555; }
        input { padding: 3px; border: 1px solid var(--border); border-radius: 2px; font-size: 11px; }

        .sidebar { flex: 1; background: white; border-radius: 4px; border: 1px solid var(--border); display: flex; flex-direction: column; max-width: 220px; flex-shrink: 0; }
        .shift-list { flex: 1; overflow-y: auto; padding: 5px; }
        .list-item { padding: 5px; border-bottom: 1px solid #eee; font-size: 10px; }
        .list-item.is-trainee-item { background-color: #f1e6ff; border-left: 4px solid var(--trainee); }
        
        button { padding: 4px 8px; border: none; border-radius: 2px; cursor: pointer; font-weight: bold; font-size: 10px; height: 24px; width: 100%; box-sizing: border-box; }
        .btn-add { background: #3498db; color: white; min-width: 60px; }
        .btn-paste { background: #e67e22; color: white; min-width: 60px; }
        .btn-clear { background: #e74c3c; color: white; min-width: 50px; }
        .btn-undo { background: #7f8c8d; color: white; min-width: 50px; }
        .btn-redo { background: #95a5a6; color: white; min-width: 50px; }
        .btn-edit { background: #f1c40f !important; color: black !important; width: auto !important; padding: 0 6px !important; }
        .btn-del { background: #e74c3c !important; color: white !important; width: auto !important; padding: 0 6px !important; }
        .btn-draft { background: #3498db; color: white; }
        .btn-commit { background: #c0392b; color: white; }
        .btn-clear-draft { background: #bdc3c7; color: #333; }

        .item-actions { display: flex; gap: 4px; margin-top: 4px; }
        .status-select { width: 60px; font-size: 9px; padding: 1px; }
        .trainer-select { width: 100%; font-size: 9px; padding: 1px; margin-top: 2px; }

        .pending-import-section { border-top: 3px solid var(--draft-color); padding: 5px; background: #fafafa; overflow-y: auto; flex: 1.5; display: none; }
        .pending-import-item { background: white; border: 1px solid #ddd; border-radius: 3px; padding: 5px; margin-bottom: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .pending-import-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .pending-cpc-tag { font-weight: 900; font-size: 11px; }
        .pending-type-badge { font-size: 8px; padding: 1px 4px; border-radius: 2px; background: #f1f3f5; font-weight: bold; }
        .pending-actions-row { display: flex; gap: 3px; justify-content: flex-end; }
        .btn-preview { background: #fff; border: 1px solid #ddd; color: #444; width: auto; height: 20px; padding: 0 4px; font-size: 9px; cursor: pointer; }
        .btn-preview.active { background: #2ecc71; color: white; border-color: #27ae60; }
        .btn-accept-req { background: #27ae60; color: white; width: 20px; height: 20px; padding: 0; font-size: 10px; }
        .btn-reject-req { background: #e74c3c; color: white; width: 20px; height: 20px; padding: 0; font-size: 10px; }

        #pasteOverlay, #traineeOverlay, #editOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; display: none; justify-content: center; align-items: center; }
        .paste-modal { background: white; padding: 15px; border-radius: 6px; width: 450px; display: flex; flex-direction: column; gap: 8px; }
        textarea { width: 100%; height: 120px; font-family: monospace; font-size: 11px; border: 1px solid #ccc; padding: 5px; box-sizing: border-box; }
        .sub-edit-row { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; background: #f8f9fa; padding: 3px; border-radius: 3px; border: 1px solid #eee; }
    </style>
</head>
<body>

<div id="pasteOverlay">
    <div class="paste-modal">
        <div style="display:flex; justify-content:space-between;"><h3>Smart Import</h3><div id="modalDraftWarning">DRAFT</div></div>
        <textarea id="bulkPasteInput" placeholder="Paste data here..."></textarea>
        <div style="display: flex; align-items: center; gap: 10px; background: #f1f3f5; padding: 8px; border-radius: 4px;">
            <label class="day-sup-container"><input type="checkbox" id="modalDaySup"> Day Sup</label>
            <label style="font-size: 11px; margin-left:10px;"><input type="checkbox" id="modalDraftMode" onchange="document.getElementById('modalDraftWarning').style.visibility=this.checked?'visible':'hidden'"> Draft Mode</label>
        </div>
        <div style="display:flex; gap: 10px;">
            <button onclick="processPaste('schedule')" style="background: #3498db; color: white; flex: 1;">Schedule</button>
            <button onclick="processPaste('leave')" style="background: #e67e22; color: white; flex: 1;">Lv/Shift Chg</button>
            <button onclick="document.getElementById('pasteOverlay').style.display='none'" style="background: #ccc; flex: 1;">Cancel</button>
        </div>
    </div>
</div>

<div id="traineeOverlay">
    <div class="paste-modal" style="width: 400px;">
        <h3>Trainee Registry</h3>
        <textarea id="traineeInput" style="height: 100px;" placeholder="Initials separated by spaces..."></textarea>
        <div style="display:flex; gap: 10px;">
            <button onclick="saveTrainees()" style="background: #27ae60; color: white; flex: 1;">Save</button>
            <button onclick="document.getElementById('traineeOverlay').style.display='none'" style="background: #ccc; flex: 1;">Close</button>
        </div>
    </div>
</div>

<div id="editOverlay">
    <div class="paste-modal">
        <h3>Edit Shift</h3>
        <div class="input-group"><label>Initials</label><input type="text" id="editInitInput" style="width: 100%;"></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="input-group"><label>Start</label><input type="text" id="editStartInput" maxlength="4"></div>
            <div class="input-group"><label>Duration</label><input type="number" id="editDurInput" step="0.5"></div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button onclick="addEditRow('LV')" style="background: #95a5a6; color: white; font-size: 10px; height: 28px;">+ Leave</button>
            <button onclick="addEditRow('XTE')" style="background: #27ae60; color: white; font-size: 10px; height: 28px;">+ XTE</button>
        </div>
        <div id="editSubItemsContainer" style="margin-top: 10px; border-top: 1px solid #ddd; padding-top: 10px;"></div>
        <div style="display:flex; gap: 10px; margin-top: 15px;">
            <button id="btnEditConfirm" style="background: #3498db; color: white; flex: 1;">Update</button>
            <button onclick="document.getElementById('editOverlay').style.display='none'" style="background: #ccc; flex: 1;">Cancel</button>
        </div>
    </div>
</div>

<header>
    <div style="font-weight: bold; font-size: 1.1rem;">Shift Graph</div>
    <div id="bigDraftWarning">DRAFT</div>
    <div style="display: flex; gap: 10px;">
        <button id="btnTrainees" style="background: #9b59b6; color: white; width: 80px;" onclick="document.getElementById('traineeOverlay').style.display='flex'; document.getElementById('traineeInput').value = localStorage.getItem('trainee_registry') || '';">Trainees</button>
        <button id="btnCreateDraft" class="btn-draft" style="width: 80px;" onclick="enableDraftMode()">Draft</button>
        <button id="btnCommitDraft" class="btn-commit" style="width: 100px; display: none;" onclick="commitDraft()">Commit</button>
        <button id="btnClearDraft" class="btn-clear-draft" style="width: 100px; display: none;" onclick="clearDraft()">Discard</button>
        <button style="background:#27ae60; color:white; width: 80px;" onclick="window.print()">Print</button>
    </div>
</header>

<div class="guidance-bar">
    <div class="guidance-section">sun-fri: <span class="blue-shift">day-8</span> | 0600: 3-5 | <span class="blue-shift">eve-9</span> | 8 until 2100</div>
    <div class="guidance-section">
        <label class="day-sup-container"><input type="checkbox" id="daySupCheckbox" onchange="toggleDaySupPreference()"> day sup</label>
        <label class="day-sup-container"><input type="checkbox" id="showNowLineCheckbox" checked onchange="toggleNowLinePreference()"> now line</label>
    </div>
</div>

<div class="main-layout">
    <div class="work-area">
        <div id="printInfo" style="font-weight: bold; margin-bottom: 2px;"></div>
        <div class="controls">
            <div class="input-group"><label>Date</label><input type="date" id="targetDate" onchange="loadDateData()"></div>
            <div class="input-group"><label>Manual</label><input type="text" id="multiInitials" placeholder="Initials"></div>
            <div class="input-group"><label>Start</label><input type="text" id="startTime" maxlength="4" style="width: 40px;" value="0700"></div>
            <div class="input-group"><label>Dur</label><input type="number" id="duration" step="0.5" value="8" style="width: 35px;"></div>
            <div class="input-group"><button class="btn-add" onclick="saveShift()">Save</button></div>
            <div class="input-group"><button class="btn-paste" onclick="document.getElementById('pasteOverlay').style.display='flex'">Paste</button></div>
            <div class="spacer" style="grid-column: 7;"></div>
            <div class="input-group"><button class="btn-clear" onclick="clearAllShifts()">Clear</button></div>
            <div class="input-group"><button id="undoBtn" class="btn-undo" onclick="undo()" disabled>Undo</button></div>
            <div class="input-group"><button id="redoBtn" class="btn-redo" onclick="redo()" disabled>Redo</button></div>
        </div>
        <div class="timeline-container" id="timelineContainer">
            <div class="scrollable-timeline">
                <div class="grid-wrapper">
                    <div id="nowLine"></div>
                    <div class="labels" id="hourLabels"></div>
                    <div class="capacity-row" id="capacityRow"></div>
                    <div class="chart-area" id="chartArea"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="sidebar">
        <div style="padding:10px; background:var(--primary); color:white; font-weight:bold; font-size:12px;">Shift List</div>
        <div id="shiftList" class="shift-list"></div>
        <div id="pendingImportList" class="pending-import-section">
            <div style="font-weight: bold; font-size: 11px; margin-bottom: 5px; color: var(--draft-color);">Pending Requests</div>
            <div id="pendingImportItems"></div>
        </div>
    </div>
</div>

<script>
    const START_HOUR = 5, TOTAL_HOURS = 24;
    let shifts = [], historyStack = [], redoStack = [], isDraft = false, previewItem = null;
    const OFF_TYPES = ["X", "HOLIDAY", "ANNUAL", "SICK", "XTU", "ADMIN", "FURLOUGH", "FSL", "HL", "AL", "SL"];
    const LEAVE_TYPES = ["ANNUAL", "SICK", "HOLIDAY", "ADMIN", "FURLOUGH", "XTU", "HL", "AL", "SL"];

    window.onload = () => {
        const now = new Date();
        document.getElementById('targetDate').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        initHeader(); loadDateData(); 
    };

    function toggleDaySupPreference() { localStorage.setItem(`day_sup_checked_${document.getElementById('targetDate').value}`, document.getElementById('daySupCheckbox').checked); render(); }
    function toggleNowLinePreference() { localStorage.setItem('show_now_line', document.getElementById('showNowLineCheckbox').checked); updateNowLine(); render(); }
    function saveHistory() { historyStack.push(JSON.stringify(shifts)); redoStack = []; if (historyStack.length > 30) historyStack.shift(); updateUndoRedoUI(); }
    function updateUndoRedoUI() { document.getElementById('undoBtn').disabled = !historyStack.length; document.getElementById('redoBtn').disabled = !redoStack.length; }
    function undo() { if (historyStack.length) { redoStack.push(JSON.stringify(shifts)); shifts = JSON.parse(historyStack.pop()); updateUndoRedoUI(); render(); } }
    function redo() { if (redoStack.length) { historyStack.push(JSON.stringify(shifts)); shifts = JSON.parse(redoStack.pop()); updateUndoRedoUI(); render(); } }
    function enableDraftMode() { isDraft = true; document.getElementById('bigDraftWarning').style.display = 'block'; document.getElementById('timelineContainer').classList.add('is-draft-mode'); document.getElementById('btnCreateDraft').style.display = 'none'; document.getElementById('btnCommitDraft').style.display = 'block'; document.getElementById('btnClearDraft').style.display = 'block'; render(); }
    function commitDraft() { if(confirm("Commit draft?")) { saveHistory(); isDraft = false; document.getElementById('timelineContainer').classList.remove('is-draft-mode'); finishUpdate(); document.getElementById('bigDraftWarning').style.display = 'none'; document.getElementById('btnCreateDraft').style.display = 'block'; document.getElementById('btnCommitDraft').style.display = 'none'; document.getElementById('btnClearDraft').style.display = 'none'; } }
    function clearDraft() { isDraft = false; document.getElementById('timelineContainer').classList.remove('is-draft-mode'); document.getElementById('bigDraftWarning').style.display = 'none'; document.getElementById('btnCreateDraft').style.display = 'block'; document.getElementById('btnCommitDraft').style.display = 'none'; document.getElementById('btnClearDraft').style.display = 'none'; loadDateData(); }
    function saveTrainees() { localStorage.setItem('trainee_registry', document.getElementById('traineeInput').value.toUpperCase()); document.getElementById('traineeOverlay').style.display='none'; render(); }

    function getNowData() {
        const n = new Date(), h = n.getHours(), m = n.getMinutes();
        let d = `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`, rh = h + m/60;
        if (h < 5) { 
            const y = new Date(n); y.setDate(n.getDate()-1); 
            d = `${y.getFullYear()}-${String(y.getMonth()+1).padStart(2,'0')}-${String(y.getDate()).padStart(2,'0')}`; 
            rh += 24; 
        }
        return { dashboardDateStr: d, offset: rh - START_HOUR };
    }

    function updateNowLine() {
        const line = document.getElementById('nowLine'), nowInfo = getNowData();
        const show = document.getElementById('showNowLineCheckbox').checked && document.getElementById('targetDate').value === nowInfo.dashboardDateStr && nowInfo.offset >= 0 && nowInfo.offset <= TOTAL_HOURS;
        line.style.display = show ? 'block' : 'none';
        if(show) line.style.left = (nowInfo.offset / TOTAL_HOURS * 100) + '%';
    }
    setInterval(() => { updateNowLine(); render(); }, 60000);

    function parseTimeInput(v) {
        if(!v || OFF_TYPES.includes(v.toString().toUpperCase())) return 0;
        let c = v.toString().replace(':', '').split('-')[0]; if (c.length < 3) return 0;
        let h = parseInt(c.substring(0, c.length - 2)), rel = h + (parseInt(c.substring(c.length - 2)) / 60);
        return (h < START_HOUR ? rel + 24 : rel) - START_HOUR;
    }
    
    function formatTimeFromOffset(o) {
        let t = (o + START_HOUR) % 24, h = Math.floor(t), m = Math.round((t - h) * 60);
        return h.toString().padStart(2, '0') + m.toString().padStart(2, '0');
    }

    function processPaste(type) {
        saveHistory();
        const raw = document.getElementById('bulkPasteInput').value, lines = raw.split('\n');
        if (type === 'schedule') {
            let curT = "0700", curD = 8;
            lines.forEach(line => {
                const cleanLine = line.trim();
                const tm = cleanLine.match(/(\d{2})?(00|30|45)/);
                const durMatch = cleanLine.match(/-(6|7|9|10|12)/);
                if (tm && line.trim().length <= 15) { curT = tm[0].slice(-4); curD = durMatch ? durMatch[1] : 8; }
                else {
                    const matches = line.match(/([A-Z]{2,3}\$?)/g);
                    if (matches) matches.forEach(m => {
                        const init = m.replace('$', '');
                        let ex = shifts.find(s => s.initials === init);
                        if (ex && Math.abs(parseTimeInput(curT) - (parseTimeInput(ex.startRaw) + ex.duration)) < 10) { ex.startRaw = curT; ex.duration = parseFloat(curD); }
                        else shifts.push({ initials: init, startRaw: curT, duration: parseFloat(curD), leave: [], xte: [], status: 'active', asStaff: false, trainer: '', pendingImport: [] });
                    });
                }
            });
        } else {
            lines.forEach(line => {
                const p = line.match(/(Annual|Sick|Shift Chg|XTU|Holiday|Admin|Furlough|FSL|HL|AL|SL)|(Shift|Approved!|Pending|Denied|X)|(\d{1,2}:\d{2})|(\d{4}(-\d+)?)|([A-Z]{2,3})/gi);
                if (!p || p.length < 2) return;
                const cpc = p.find(i => /^[A-Z]{2,3}$/.test(i.toUpperCase()))?.toUpperCase();
                const ty = p.find(i => ["ANNUAL", "SICK", "SHIFT CHG", "XTU", "HOLIDAY", "ADMIN", "FURLOUGH", "FSL", "HL", "AL", "SL"].includes(i.toUpperCase()))?.toUpperCase();
                const st = p.find(i => ["APPROVED!", "PENDING", "DENIED"].includes(i.toUpperCase()))?.toUpperCase();
                if (ty === "SHIFT CHG" && st === "APPROVED!") return;
                const times = p.filter(i => /^(\d{1,2}:\d{2})$/.test(i) || /^(\d{4}(-\d+)?)$/.test(i));
                let fr = p.find(i => OFF_TYPES.includes(i.toUpperCase()) || i.toLowerCase() === "shift") || times[0] || "";
                let to = (fr === times[0]) ? (times[1] || times[0]) : (times[0] || "");
                let target = shifts.find(s => s.initials === cpc);
                if (!target) { target = { initials: cpc, startRaw: '0000', duration: 0, leave: [], xte: [], status: 'inactive', asStaff: false, trainer: '', pendingImport: [], isGhost: true }; shifts.push(target); }
                if (st === "APPROVED!") {
                    if (LEAVE_TYPES.includes(ty) && fr.toLowerCase() === "shift") { shifts = shifts.filter(s => s !== target); return; }
                    target.leave.push({ startRaw: fr.replace(':',''), endRaw: to.replace(':',''), type: ty.replace("ANNUAL","AL").replace("SICK","SL") });
                } else target.pendingImport.push({ cpc, type: ty, from: fr, to, status: st, processed: false, pasteOrder: Date.now() });
            });
        }
        togglePaste(false); finishUpdate();
    }

    function handleImportAction(sIdx, piIdx, action) {
        if (action === 'preview') { previewItem = (previewItem && previewItem.sIdx === sIdx && previewItem.piIdx === piIdx) ? null : { sIdx, piIdx }; render(); return; }
        previewItem = null; saveHistory();
        const s = shifts[sIdx], row = s.pendingImport[piIdx];
        if (action === 'approve') {
            if (row.type === "SHIFT CHG") { let t = row.to.replace(':',''); s.startRaw = t.split('-')[0]; s.duration = parseFloat(t.split('-')[1] || 8); s.status = 'active'; s.isGhost = false; }
            else s.leave.push({ startRaw: row.from.replace(':',''), endRaw: row.to.replace(':',''), type: row.type });
            s.pendingImport.splice(piIdx, 1);
        } else if (action === 'reject') s.pendingImport.splice(piIdx, 1);
        finishUpdate();
    }

    function initHeader() {
        const l = document.getElementById('hourLabels'), c = document.getElementById('capacityRow');
        l.innerHTML = ''; c.innerHTML = '';
        for (let i = 0; i < TOTAL_HOURS; i++) {
            l.innerHTML += `<div class="hour-label">${(START_HOUR + i) % 24}00</div>`;
            c.innerHTML += `<div class="cap-cell" id="cap-${i}">0</div>`;
        }
    }

    function loadDateData() {
        const dv = document.getElementById('targetDate').value;
        shifts = JSON.parse(localStorage.getItem(`staff_data_${dv}`)) || [];
        document.getElementById('printInfo').innerText = dv ? new Date(dv + 'T00:00:00').toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : "";
        render();
    }

    function saveShift() {
        saveHistory();
        const inp = document.getElementById('multiInitials').value.trim();
        if (inp) {
            inp.split(/\s+/).forEach(init => { shifts.push({ initials: init.toUpperCase(), startRaw: document.getElementById('startTime').value || '0700', duration: parseFloat(document.getElementById('duration').value) || 8, leave: [], xte: [], status: 'active', asStaff: false, trainer: '', pendingImport: [] }); });
            finishUpdate(); document.getElementById('multiInitials').value = '';
        }
    }

    function toggleStatus(i, v) { saveHistory(); shifts[i].status = v; finishUpdate(); }
    function toggleAsStaff(i, v) { saveHistory(); shifts[i].asStaff = v; finishUpdate(); }
    function setTrainer(i, v) { saveHistory(); shifts[i].trainer = v; finishUpdate(); }
    function deleteShift(i) { if(confirm("Delete?")) { saveHistory(); shifts.splice(i, 1); finishUpdate(); } }
    function clearAllShifts() { if(confirm("Clear ALL?")) { saveHistory(); shifts = []; finishUpdate(); } }
    function finishUpdate() { localStorage.setItem(`staff_data_${document.getElementById('targetDate').value}`, JSON.stringify(shifts)); render(); }
    function closeEditModal() { document.getElementById('editOverlay').style.display = 'none'; }

    function addEditRow(type, start = "0000", end = "0000") {
        const div = document.createElement('div'); div.className = 'sub-edit-row';
        div.innerHTML = `<span style="font-size:10px; font-weight:bold; min-width:30px;">${type}</span>
                       <input type="text" value="${start}" class="start" style="width:50px"> to <input type="text" value="${end}" class="end" style="width:50px">
                       <button onclick="this.parentElement.remove()" style="width:20px; height:20px; padding:0; background:none; color:red; border:none; font-size:14px;">×</button>`;
        document.getElementById('editSubItemsContainer').appendChild(div);
    }

    function openEditModal(i) {
        const s = shifts[i], overlay = document.getElementById('editOverlay'); overlay.style.display = 'flex';
        document.getElementById('editInitInput').value = s.initials; document.getElementById('editStartInput').value = s.startRaw; document.getElementById('editDurInput').value = s.duration;
        const container = document.getElementById('editSubItemsContainer'); container.innerHTML = '';
        s.leave.forEach(l => addEditRow('LV', l.startRaw, l.endRaw)); s.xte.forEach(x => addEditRow('XTE', x.startRaw, x.endRaw));
        document.getElementById('btnEditConfirm').onclick = () => {
            saveHistory(); s.initials = document.getElementById('editInitInput').value.toUpperCase(); s.startRaw = document.getElementById('editStartInput').value; s.duration = parseFloat(document.getElementById('editDurInput').value);
            s.leave = []; s.xte = [];
            container.querySelectorAll('.sub-edit-row').forEach(row => {
                const label = row.innerText.trim().substring(0,2), data = { startRaw: row.querySelector('.start').value, endRaw: row.querySelector('.end').value, type: label };
                if(label === 'LV') s.leave.push(data); else s.xte.push(data);
            });
            finishUpdate(); overlay.style.display = 'none';
        };
    }

    function createBar(s, isT, isShiftChgP, isActuallyOver, pReq, isLvP) {
        let sOff = parseTimeInput(s.startRaw), eOff = sOff + s.duration;
        const bar = document.createElement('div');
        let classes = `shift-bar`;
        
        if (isT) classes += ` trainee-bar`;
        if (isShiftChgP || s.status==='inactive' || isActuallyOver) classes += ` inactive-bar`;
        if (isShiftChgP) classes += ` preview-original-dashed`;
        
        bar.className = classes;
        
        bar.style.left = (sOff/TOTAL_HOURS*100)+'%'; 
        bar.style.width = (s.duration/TOTAL_HOURS*100)+'%';
        
        bar.innerHTML = `<span class="bar-text">${s.initials} ${s.startRaw}-${formatTimeFromOffset(eOff)}</span>`;
        
        // Stripes for Trainer Overlap
        if (!isT) {
            const traineesUnderMe = shifts.filter(t => (localStorage.getItem('trainee_registry') || "").includes(t.initials) && t.trainer === s.initials);
            traineesUnderMe.forEach(t => {
                let tS = parseTimeInput(t.startRaw), tE = tS + t.duration;
                let oS = Math.max(sOff, tS), oE = Math.min(eOff, tE);
                if (oE > oS) {
                    const stripe = document.createElement('div'); stripe.className = 'training-overlap-overlay';
                    stripe.style.left = (((oS - sOff) / s.duration) * 100) + '%'; stripe.style.width = (((oE - oS) / s.duration) * 100) + '%';
                    bar.appendChild(stripe);
                }
            });
        }

        // Yellow Handover
        if (s.status === 'active' && !isT && !isShiftChgP && !isActuallyOver) {
            let hSlot = eOff - 1;
            const lvEnd = (s.leave || []).find(l => Math.abs(parseTimeInput(l.endRaw) - eOff) <= 0.1);
            if (lvEnd) hSlot = parseTimeInput(lvEnd.startRaw) - 1;
            if (!(eOff > 17 || (parseInt(formatTimeFromOffset(eOff)) >= 300 && parseInt(formatTimeFromOffset(eOff)) <= 800))) {
                const hOver = document.createElement('div'); hOver.className = 'handover-overlay';
                hOver.style.left = (((hSlot - sOff) / s.duration) * 100) + '%'; hOver.style.width = ((1 / s.duration) * 100) + '%';
                bar.appendChild(hOver);
            }
        }
        (s.xte||[]).forEach(x => { const xS = parseTimeInput(x.startRaw), xE = parseTimeInput(x.endRaw); const d = document.createElement('div'); d.className='xte-overlay'; d.style.left=(((xS-sOff)/s.duration)*100)+'%'; d.style.width=(((xE-xS)/s.duration)*100)+'%'; d.innerText=`XTE ${x.startRaw}`; bar.appendChild(d); });
        (s.leave||[]).forEach(l => { const lS = parseTimeInput(l.startRaw), lE = parseTimeInput(l.endRaw); const d = document.createElement('div'); d.className='leave-overlay'; d.style.left=(((lS-sOff)/s.duration)*100)+'%'; d.style.width=(((lE-lS)/s.duration)*100)+'%'; d.innerText=`${l.type} ${l.startRaw}`; bar.appendChild(d); });
        
        if(isLvP) {
            const pS = parseTimeInput(pReq.from), pE = parseTimeInput(pReq.to);
            const pBar = document.createElement('div'); pBar.className = 'shift-bar preview-highlight';
            pBar.style.left = (((pS-sOff)/s.duration)*100)+'%'; pBar.style.width = (((pE-pS)/s.duration)*100)+'%';
            pBar.style.background = ["XTU","XTE"].includes(pReq.type) ? 'var(--xte)' : 'var(--leave)';
            pBar.innerHTML = `<span class="bar-text" style="color:${["XTU","XTE"].includes(pReq.type)?'black':'white'}">${pReq.type} ${pReq.from.replace(':','')} - ${pReq.to.replace(':','')}</span>`;
            bar.appendChild(pBar);
        }
        return bar;
    }

    function render() {
        const chart = document.getElementById('chartArea'), list = document.getElementById('shiftList'), importList = document.getElementById('pendingImportItems');
        chart.innerHTML = ''; list.innerHTML = ''; importList.innerHTML = '';
        const counts = new Array(TOTAL_HOURS).fill(0), nowInfo = getNowData(), traineeReg = (localStorage.getItem('trainee_registry') || "").split(/\s+/).filter(Boolean);
        const targetDate = document.getElementById('targetDate').value, supChecked = document.getElementById('daySupCheckbox').checked;

        let displayList = shifts.map((s, i) => ({ ...s, origIdx: i, isPreview: false, sortVal: parseTimeInput(s.startRaw) }));
        let currentPReq = null;
        if (previewItem) {
            const src = shifts[previewItem.sIdx]; currentPReq = src.pendingImport[previewItem.piIdx];
            if (currentPReq.type === "SHIFT CHG") {
                let t = currentPReq.to.replace(':',''), st = t.split('-')[0], dur = parseFloat(t.split('-')[1] || 8), off = parseTimeInput(st);
                displayList.push({ initials: src.initials, pStartOff: off, pDur: dur, pType: "SHIFT CHG", isPreview: true, sortVal: off });
            }
        }
        displayList.sort((a, b) => a.sortVal - b.sortVal);

        let renderOrder = [];
        let processedIds = new Set();

        // 1. Build Render Order (Trainer -> Trainee)
        displayList.forEach(item => {
            if (processedIds.has(item.origIdx)) return;
            
            // Skip trainees who have a valid trainer (they will be injected after their trainer)
            if (!item.isPreview && traineeReg.includes(item.initials) && item.trainer && shifts.some(s => s.initials === item.trainer)) return;

            renderOrder.push(item);
            processedIds.add(item.origIdx);

            // If this item is a trainer, find their trainees and inject them immediately after
            if (!item.isPreview) {
                let myTrainees = displayList.filter(t => !t.isPreview && traineeReg.includes(t.initials) && t.trainer === item.initials && !processedIds.has(t.origIdx));
                myTrainees.forEach(t => {
                    renderOrder.push(t);
                    processedIds.add(t.origIdx);
                });
            }
        });

        // 2. Render Rows
        renderOrder.forEach(item => {
            const row = document.createElement('div'); row.className = 'shift-row';
            
            if (item.isPreview) {
                const pBar = document.createElement('div'); pBar.className = 'shift-bar preview-highlight';
                pBar.style.left = (item.pStartOff / TOTAL_HOURS * 100) + '%'; pBar.style.width = (item.pDur / TOTAL_HOURS * 100) + '%';
                pBar.innerHTML = `<span class="bar-text">${item.initials} ${formatTimeFromOffset(item.pStartOff)}-${formatTimeFromOffset(item.pStartOff + item.pDur)}</span>`;
                for(let h=0; h<TOTAL_HOURS; h++) if(Math.max(item.pStartOff, h) < Math.min(item.pStartOff + item.pDur, h+1)) counts[h]++;
                row.appendChild(pBar);
            } else {
                const isP = previewItem && previewItem.sIdx === item.origIdx, isT = traineeReg.includes(item.initials) && !item.asStaff;
                let sOff = parseTimeInput(item.startRaw), eOff = sOff + item.duration;
                
                const isActuallyOver = (targetDate === nowInfo.dashboardDateStr && eOff <= nowInfo.offset);
                const isShiftChgP = isP && currentPReq && currentPReq.type === "SHIFT CHG", isLvP = isP && currentPReq && currentPReq.type !== "SHIFT CHG";

                if (item.status === 'active' && !isT && !item.isGhost && !isShiftChgP) {
                    for(let h=0; h<TOTAL_HOURS; h++) {
                        const inExistingL = (item.leave || []).some(l => Math.max(parseTimeInput(l.startRaw), h) < Math.min(parseTimeInput(l.endRaw), h+1));
                        const inPropL = isLvP && Math.max(parseTimeInput(currentPReq.from), h) < Math.min(parseTimeInput(currentPReq.to), h+1);
                        if(Math.max(sOff, h) < Math.min(eOff, h+1) && !inExistingL && !inPropL && !((h+START_HOUR)%24 < 20 && h >= (eOff-1))) counts[h]++;
                    }
                }
                row.appendChild(createBar(item, isT, isShiftChgP, isActuallyOver, currentPReq, isLvP));
            }
            chart.appendChild(row);
        });

        shifts.forEach((s, i) => {
            if (s.isGhost && (!s.pendingImport || s.pendingImport.length === 0)) return;
            const isT = traineeReg.includes(s.initials);
            let trC = isT ? `<select class="trainer-select" onchange="setTrainer(${i}, this.value)"><option value="">None</option>${shifts.filter(o => o.initials!==s.initials && (!traineeReg.includes(o.initials)||o.asStaff)).map(o => `<option value="${o.initials}" ${s.trainer===o.initials?'selected':''}>${o.initials}</option>`).join('')}</select>` : '';
            let staffCheck = isT ? `<label style="font-size: 10px; display: flex; align-items: center; gap: 4px; cursor: pointer; margin-top: 4px;"><input type="checkbox" ${s.asStaff ? 'checked' : ''} onchange="toggleAsStaff(${i}, this.checked)"> Staffing</label>` : '';
            list.innerHTML += `<div class="list-item ${isT?'is-trainee-item':''}"><div style="display:flex; justify-content:space-between; align-items:flex-start;"><div><b>${s.initials}</b> <small>${s.startRaw} (${s.duration}h)</small>${trC}</div><div style="display:flex; flex-direction:column; align-items:flex-end;"><select class="status-select" onchange="toggleStatus(${i}, this.value)"><option value="active" ${s.status === 'active' ? 'selected' : ''}>Active</option><option value="inactive" ${s.status === 'inactive' ? 'selected' : ''}>Inactive</option></select>${staffCheck}</div></div><div class="item-actions"><button class="btn-edit" onclick="openEditModal(${i})">Edit</button><button class="btn-del" onclick="deleteShift(${i})">Del</button></div></div>`;
        });

        let allP = []; shifts.forEach((s, sIdx) => s.pendingImport?.forEach((pi, piIdx) => allP.push({...pi, sIdx, piIdx})));
        if (allP.length > 0) {
            document.getElementById('pendingImportList').style.display = 'block';
            allP.forEach(pi => {
                const active = previewItem && previewItem.sIdx === pi.sIdx && previewItem.piIdx === pi.piIdx;
                importList.innerHTML += `<div class="pending-import-item" style="padding:10px;"><div style="display:flex; justify-content:space-between; font-weight:bold; font-size:12px;"><span>${pi.cpc}</span><span style="color:var(--draft-color); font-size:10px;">${pi.type}</span></div><div style="font-family:monospace; font-size:11px; margin:5px 0;">${pi.from} - ${pi.to}</div><div style="display:flex; gap:5px; justify-content:flex-end;"><button class="btn-preview ${active?'active':''}" onclick="handleImportAction(${pi.sIdx}, ${pi.piIdx}, 'preview')">Preview</button><button class="btn-accept-req" onclick="handleImportAction(${pi.sIdx}, ${pi.piIdx}, 'approve')">✓</button><button class="btn-reject-req" onclick="handleImportAction(${pi.sIdx}, ${pi.piIdx}, 'reject')">×</button></div></div>`;
            });
        } else document.getElementById('pendingImportList').style.display = 'none';

        counts.forEach((c, i) => {
            const cell = document.getElementById(`cap-${i}`); cell.innerText = c || '-'; cell.className = 'cap-cell';
            const h = (i + START_HOUR) % 24; let m = false, sup = document.getElementById('daySupCheckbox').checked;
            const isSF = (new Date(targetDate + 'T00:00:00').getDay() !== 6);
            if (isSF && h === 6) { cell.classList.add((sup ? c >= 3 : c >= 4) ? 'cap-green' : 'cap-red'); m = true; }
            else if (isSF && [20, 21, 22].includes(h)) { cell.classList.add(c >= (h===20?8:h===21?5:3) ? 'cap-green' : 'cap-red'); m = true; }
            else if (!isSF && h === 21) { cell.classList.add(c >= 5 ? 'cap-green' : 'cap-red'); m = true; }
            if (!m && h >= 7 && h <= 20) { if (c <= 5) cell.classList.add('cap-red'); else if (c === 6) cell.classList.add('cap-yellow'); }
        });
        updateNowLine();
    }
    initHeader(); loadDateData();
</script>
</body>
</html>
