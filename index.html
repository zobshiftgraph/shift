<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Graph v13.6</title>
    <style>
        :root { 
            --primary: #2c3e50; 
            --accent: #72b5f6; 
            --bg: #f8f9fa; 
            --leave: rgba(100, 100, 100, 0.8); 
            --xte: #d4f7d4; 
            --handover: rgba(255, 242, 0, 0.7); 
            --border: #dee2e6;
            --inactive: #bdc3c7; 
            --now: #e74c3c;
            --draft-color: #9b59b6;
            --trainee: #d1b3ff; 
        }
        
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background-color: #e9ecef; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .guidance-bar {
            background: #ffffff;
            border-bottom: 1px solid var(--border);
            padding: 8px 20px;
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
            font-size: 11px; font-weight: bold; line-height: 1.4;
        }
        .guidance-section { display: flex; align-items: center; gap: 8px; border-right: 2px solid #ddd; padding-right: 15px; }
        .guidance-section:last-child { border-right: none; }
        .guidance-text { font-weight: normal; color: #444; }
        .blue-shift { color: #3498db; font-weight: bold; }

        .day-sup-container { display: flex; align-items: center; gap: 4px; margin-left: 10px; cursor: pointer; }
        .day-sup-container input { cursor: pointer; margin: 0; width: 14px; height: 14px; }

        .cap-green { background-color: #d4edda !important; color: #155724 !important; }
        .cap-yellow { background-color: #fff3cd !important; color: #856404 !important; }
        .cap-red { background-color: #f8d7da !important; color: #721c24 !important; }

        @media print {
            header, .controls, #pasteOverlay, #traineeOverlay, #actionOverlay, #editOverlay, .btn-clear, .btn-undo, .btn-redo, .item-actions, .status-select, #nowLine, #draftBadge, #bigDraftWarning, #btnCommitDraft, .sidebar, .guidance-bar { display: none !important; }
            html, body { height: auto !important; overflow: visible !important; background: white !important; }
            .main-layout { display: block !important; width: 100% !important; height: auto !important; padding: 0 !important; zoom: 0.9; }
            .work-area { width: 100% !important; }
            .print-header { display: block !important; font-size: 16pt; margin-bottom: 10px; font-weight: 600; text-align: center; }
            .timeline-container { border: 2px solid #000 !important; background: white !important; overflow: visible !important; }
            .scrollable-timeline { overflow: visible !important; }
            .grid-wrapper { width: 100% !important; min-width: 0 !important; }
            .labels, .capacity-row { display: grid !important; grid-template-columns: repeat(22, 1fr) !important; background: white !important; }
            .hour-label, .cap-cell { font-size: 10pt !important; border-right: 1px solid #000 !important; border-bottom: 2px solid #000 !important; }
            .chart-area { min-height: 400px !important; background: white !important; -webkit-print-color-adjust: exact; }
            .shift-bar { border: 1.5px solid #000 !important; -webkit-print-color-adjust: exact; }
        }

        header { background: var(--primary); color: white; padding: 0.8rem 2rem; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; position: relative; }
        #bigDraftWarning { display: none; position: absolute; left: 50%; transform: translateX(-50%); color: #ff3e3e; font-size: 28px; font-weight: 900; letter-spacing: 5px; pointer-events: none; z-index: 100; }
        .main-layout { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 15px; min-height: 0; }
        .work-area { flex: 3; display: flex; flex-direction: column; gap: 15px; min-width: 0; height: 100%; }
        
        .timeline-container { background: white; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        .timeline-container.is-draft-mode { border: 4px solid #e74c3c !important; }

        .scrollable-timeline { overflow-x: auto; overflow-y: hidden; flex: 1; position: relative; }
        .grid-wrapper { position: relative; min-width: 0; width: 100%; display: flex; flex-direction: column; height: 100%; }
        
        .labels { display: grid; grid-template-columns: repeat(22, 1fr); background: #f1f3f5; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; flex-shrink: 0; }
        .hour-label { font-size: 11px; text-align: center; padding: 8px 0; transform: translateX(-50%); }
        
        .capacity-row { display: grid; grid-template-columns: repeat(22, 1fr); width: 100%; background: #fffbe6; border-bottom: 2px solid var(--border); font-weight: bold; color: #856404; position: sticky; top: 31px; z-index: 10; flex-shrink: 0; }
        .cap-cell { font-size: 11px; text-align: center; padding: 8px 0; border-right: 1px solid #dee2e6; }
        
        .chart-area { position: relative; width: 100%; flex: 1; display: flex; flex-direction: column; background-image: linear-gradient(to right, #f1f3f5 1px, transparent 1px); background-size: calc(100% / 22) 100%; }
        
        #nowLine { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--now); z-index: 20; pointer-events: none; }
        #nowLine::after { content: 'NOW'; position: absolute; top: 0; left: 2px; background: var(--now); color: white; font-size: 8px; padding: 1px 3px; border-radius: 0 0 3px 0; font-weight: bold; }

        .controls { background: white; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: auto auto auto auto auto auto 1fr auto auto auto; gap: 10px; align-items: end; flex-shrink: 0; }
        .input-group { display: flex; flex-direction: column; gap: 4px; height: 100%; justify-content: flex-end; }
        label { font-size: 9px; font-weight: bold; color: #495057; text-transform: uppercase; }
        input { padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; }
        
        #multiInitials { width: 13ch; }

        button { padding: 9px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; height: 35px; width: 100%; box-sizing: border-box; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-add { background: #3498db; color: white; min-width: 100px; }
        .btn-paste { background: #e67e22; color: white; min-width: 100px; }
        .btn-clear { background: #e74c3c; color: white; min-width: 80px; }
        .btn-undo { background: #7f8c8d; color: white; min-width: 80px; }
        .btn-redo { background: #95a5a6; color: white; min-width: 80px; }
        .btn-draft { background: #3498db; color: white; }
        .btn-commit { background: #c0392b; color: white; }
        .btn-clear-draft { background: #bdc3c7; color: #333; }
        
        .spacer { grid-column: 7; }

        .shift-row { position: relative; flex: 1; border-bottom: 1px solid #f1f3f5; width: 100%; }
        .shift-bar { position: absolute; height: 80%; top: 10%; background: var(--accent); color: #000; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap; box-sizing: border-box; box-shadow: 1px 1px 3px rgba(0,0,0,0.1); z-index: 1; display: flex; align-items: center; overflow: hidden; }
        .bar-text { position: sticky; left: 0; right: 0; width: 100%; text-align: center; flex-shrink: 0; pointer-events: none; z-index: 10; }
        .shift-bar.inactive-bar { background: var(--inactive) !important; color: #7f8c8d !important; }
        .shift-bar.trainee-bar { background: var(--trainee); }
        .is-changed { outline: 2px solid #e74c3c; outline-offset: -2px; z-index: 50; }
        
        .sidebar { flex: 1; background: white; border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; max-width: 250px; flex-shrink: 0; }
        .shift-list { flex: 1; overflow-y: auto; padding: 10px; }
        .list-item { padding: 10px 8px; border-bottom: 1px solid #eee; font-size: 11px; position: relative; }
        .list-item.is-trainee-item { background-color: #f1e6ff; }
        .registry-shift-info { display: block; font-size: 10px; color: #666; margin-top: 1px; }

        .pending-import-section { border-top: 3px solid var(--draft-color); padding: 10px; background: #fef9ff; max-height: 400px; overflow-y: auto; }
        .pending-import-item { font-size: 10px; border-bottom: 1px solid #ddd; padding: 8px 0; display: flex; justify-content: space-between; align-items: center; }
        .pending-import-item.processed { opacity: 0.5; filter: grayscale(1); background: #f0f0f0; }
        .pending-import-data { line-height: 1.4; flex: 1; }
        .pending-import-actions { display: flex; gap: 8px; align-items: center; }
        
        .registry-leave-container { display: flex; flex-direction: row; flex-wrap: wrap; gap: 4px; margin-top: 3px; }
        .registry-leave-tag { background: #34495e; color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px; display: flex; align-items: center; gap: 5px; font-weight: bold; white-space: nowrap; line-height: 1.2; }
        .tag-xte { background: var(--xte) !important; color: black !important; border: 1px solid #777; }
        .tag-pending { background: #f39c12 !important; color: white !important; border: 1px dashed white; }
        
        .btn-del-leave { cursor: pointer; border: none; background: transparent; color: inherit; font-weight: bold; font-size: 12px; line-height: 1; padding: 0; }
        .btn-accept-leave { cursor: pointer; border: none; background: transparent; color: #2ecc71; font-weight: bold; font-size: 14px; padding: 0 2px; line-height: 1; }
        .btn-revert-leave { cursor: pointer; border: none; background: transparent; color: #3498db; font-weight: bold; font-size: 18px; padding: 0 2px; line-height: 1; }
        
        .item-actions { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
        .btn-edit, .btn-del, .btn-leave, .btn-xte { padding: 3px 6px; border-radius: 3px; font-size: 9px; height: auto; width: auto; color: white; }
        .btn-edit { background: #f1c40f; color: black; }
        .btn-del { background: #e74c3c; }
        .btn-leave { background: #95a5a6; }
        .btn-xte { background: #27ae60; }
        .status-select, .trainer-select { font-size: 10px; padding: 2px; border-radius: 3px; border: 1px solid var(--border); width: 100%; }
        
        #pasteOverlay, #traineeOverlay, #actionOverlay, #editOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; display: none; justify-content: center; align-items: center; }
        .paste-modal { background: white; padding: 20px; border-radius: 12px; width: 600px; display: flex; flex-direction: column; gap: 10px; max-height: 90vh; overflow-y: auto; }
        textarea { width: 100%; height: 180px; font-family: monospace; font-size: 12px; border: 1px solid #ccc; padding: 8px; }
        
        .modal-input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        .sub-edit-row { display: flex; gap: 5px; align-items: center; margin-top: 5px; background: #f8f9fa; padding: 5px; border-radius: 4px; border: 1px solid #eee; }
        .sub-edit-label { font-size: 9px; font-weight: bold; width: 45px; }
        .sub-edit-input { padding: 4px !important; font-size: 11px !important; }

        .modal-header-row { display: flex; align-items: center; position: relative; margin-bottom: 5px; justify-content: center; }
        .modal-header-row h3 { position: absolute; left: 0; margin: 0; }
        #modalDraftWarning { color: #e74c3c; font-size: 24px; font-weight: 900; visibility: hidden; }

        .training-overlap-overlay { position: absolute; height: 100%; top: 0; z-index: 4; pointer-events: none; background: repeating-linear-gradient(45deg, rgba(209, 179, 255, 0.7), rgba(209, 179, 255, 0.7) 10px, rgba(114, 181, 246, 0.7) 10px, rgba(114, 181, 246, 0.7) 20px); }
        .handover-overlay { position: absolute; height: 100%; top:0; background: var(--handover); z-index: 5; pointer-events: none; }
        .leave-overlay { position: absolute; height: 100%; top: 0; z-index: 6; pointer-events: none; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; text-align: center; line-height: 1; white-space: nowrap; background: var(--leave); color: white; }
        .xte-overlay { position: absolute; height: 100%; top: 0; z-index: 7; pointer-events: none; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; text-align: center; line-height: 1; white-space: nowrap; background: var(--xte); color: black; }
    </style>
</head>
<body>

<div id="pasteOverlay">
    <div class="paste-modal">
        <div class="modal-header-row">
            <h3 style="margin: 0;">Smart Import</h3>
            <div id="modalDraftWarning">DRAFT</div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; padding: 5px 0;">
             <label style="font-size: 14px; font-weight: bold; cursor: pointer;">
                <input type="checkbox" id="modalDraftMode" onchange="toggleModalDraftWarning()"> Draft Mode
            </label>
        </div>
        <textarea id="bulkPasteInput" placeholder="Paste schedule or leave data here..."></textarea>
        <div style="display: flex; align-items: center; gap: 10px; background: #f1f3f5; padding: 8px; border-radius: 4px;">
            <label class="day-sup-container" style="font-size: 11px;"><input type="checkbox" id="modalDaySup"> Day Sup</label>
        </div>
        <div style="display:flex; gap: 10px;">
            <button onclick="processPaste('schedule')" style="background: #3498db; color: white; flex: 1;">Submit Schedule</button>
            <button onclick="processPaste('leave')" style="background: #e67e22; color: white; flex: 1;">Submit Lv/Shift Chg</button>
            <button onclick="togglePaste(false)" style="background: #ccc; flex: 1;">Cancel</button>
        </div>
    </div>
</div>

<div id="traineeOverlay">
    <div class="paste-modal" style="width: 400px;">
        <h3 style="margin: 0;">Trainee Registry</h3>
        <label>Enter Trainee Initials (space separated)</label>
        <textarea id="traineeInput" style="height: 100px; text-transform: uppercase;" placeholder="e.g. AB CD EF"></textarea>
        <div style="display:flex; gap: 10px;">
            <button onclick="saveTrainees()" style="background: #27ae60; color: white; flex: 1;">Save Trainees</button>
            <button onclick="toggleTrainees(false)" style="background: #ccc; flex: 1;">Close</button>
        </div>
    </div>
</div>

<div id="actionOverlay">
    <div class="paste-modal" style="width: 350px;">
        <h3 id="actionTitle" style="margin: 0;">Add Leave</h3>
        <p id="actionSubtext" style="font-size: 13px; margin: 5px 0;"></p>
        <input type="text" id="actionRangeInput" placeholder="e.g. 0800-1000" style="width: 100%; box-sizing: border-box;">
        <div style="display:flex; gap: 10px; margin-top: 10px;">
            <button id="btnActionConfirm" style="background: #3498db; color: white; flex: 1;">Confirm</button>
            <button onclick="closeActionModal()" style="background: #ccc; flex: 1;">Cancel</button>
        </div>
    </div>
</div>

<div id="editOverlay">
    <div class="paste-modal" style="width: 400px;">
        <h3 style="margin: 0;">Edit Shift</h3>
        <p id="editSubtext" style="font-size: 13px; margin: 5px 0;"></p>
        <div class="input-group"><label>Initials</label><input type="text" id="editInitInput" style="width: 100%; box-sizing: border-box;"></div>
        <div class="modal-input-grid">
            <div class="input-group"><label>Start Time</label><input type="text" id="editStartInput" maxlength="4" style="width: 100%; box-sizing: border-box;"></div>
            <div class="input-group"><label>Duration</label><input type="number" id="editDurInput" step="0.5" style="width: 100%; box-sizing: border-box;"></div>
        </div>
        <div id="editSubItemsContainer" style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px;"></div>
        <div style="display:flex; gap: 10px; margin-top: 15px;">
            <button id="btnEditConfirm" style="background: #3498db; color: white; flex: 1;">Update Shift</button>
            <button onclick="closeEditModal()" style="background: #ccc; flex: 1;">Cancel</button>
        </div>
    </div>
</div>

<header>
    <div style="font-weight: bold; font-size: 1.2rem;">Shift Graph</div>
    <div id="bigDraftWarning">DRAFT</div>
    <div style="display: flex; gap: 10px;">
        <button id="btnTrainees" style="background: #9b59b6; color: white; width: 120px;" onclick="toggleTrainees(true)">Trainees</button>
        <button id="btnCreateDraft" class="btn-draft" style="width: 120px;" onclick="enableDraftMode()">Create Draft</button>
        <button id="btnCommitDraft" class="btn-commit" style="width: 130px; display: none;" onclick="commitDraft()">Replace Original</button>
        <button id="btnClearDraft" class="btn-clear-draft" style="width: 120px; display: none;" onclick="clearDraft()">Discard Draft</button>
        <button style="background:#27ae60; color:white; width: 120px;" onclick="window.print()">Print Graph</button>
    </div>
</header>

<div class="guidance-bar">
    <div class="guidance-section">sun-fri: <span class="guidance-text"><span class="blue-shift">day-8</span> | 0600: 3-5 | 4 w/no sup | <span class="blue-shift">eve-9</span> | 8 until 2100 | 5 after 2100 | 3 until 2300</span></div>
    <div class="guidance-section">sat: <span class="guidance-text">5 cpcs after 2100</span>
        <label class="day-sup-container"><input type="checkbox" id="daySupCheckbox" onchange="toggleDaySupPreference()"> day sup</label>
        <label class="day-sup-container"><input type="checkbox" id="showNowLineCheckbox" checked onchange="toggleNowLinePreference()"> show now line</label>
    </div>
</div>

<div class="main-layout">
    <div class="work-area">
        <div id="printInfo" class="print-header"></div>
        <div class="controls">
            <div class="input-group"><label>Date</label><input type="date" id="targetDate" onchange="loadDateData()"></div>
            <div class="input-group"><label>Manual Entry</label><input type="text" id="multiInitials" placeholder="Initials"></div>
            <div class="input-group"><label>Start</label><input type="text" id="startTime" maxlength="4" style="width: 60px;" placeholder="0800"></div>
            <div class="input-group"><label>Dur</label><input type="number" id="duration" step="0.5" value="8" style="width: 50px;"></div>
            <div class="input-group"><button class="btn-add" id="addBtn" onclick="saveShift()">Save Shift</button></div>
            <div class="input-group"><button class="btn-paste" onclick="togglePaste(true)">Paste Data</button></div>
            <div class="spacer"></div>
            <div class="input-group"><button class="btn-clear" onclick="clearAllShifts()">Clear All</button></div>
            <div class="input-group"><button id="undoBtn" class="btn-undo" onclick="undo()" disabled>Undo</button></div>
            <div class="input-group"><button id="redoBtn" class="btn-redo" onclick="redo()" disabled>Redo</button></div>
        </div>
        <div class="timeline-container" id="timelineContainer">
            <div class="scrollable-timeline">
                <div class="grid-wrapper" id="gridWrapper">
                    <div id="nowLine"></div>
                    <div class="labels" id="hourLabels"></div>
                    <div class="capacity-row" id="capacityRow"></div>
                    <div class="chart-area" id="chartArea"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="sidebar">
        <div style="padding:10px; background:var(--primary); color:white; font-weight:bold; font-size:12px;" id="sidebarHeader">Shift List</div>
        <div id="shiftList" class="shift-list"></div>
        <div id="pendingImportList" class="pending-import-section">
            <div style="font-weight: bold; font-size: 11px; margin-bottom: 5px; color: var(--draft-color);">Pending Requests</div>
            <div id="pendingImportItems"></div>
        </div>
    </div>
</div>

<script>
    const START_HOUR = 5, TOTAL_HOURS = 22;
    let shifts = [];
    let historyStack = [];
    let redoStack = [];
    let isDraft = false;
    const OFF_TYPES = ["X", "HOLIDAY", "ANNUAL", "SICK", "XTU", "ADMIN", "FURLOUGH", "FSL", "HL", "AL", "SL"];
    const LEAVE_TYPES = ["ANNUAL", "SICK", "HOLIDAY", "ADMIN", "FURLOUGH", "XTU", "HL", "AL", "SL"];

    window.onload = function() { 
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const todayStr = `${year}-${month}-${day}`;
        document.getElementById('targetDate').value = todayStr;
        const nowLinePref = localStorage.getItem('show_now_line');
        document.getElementById('showNowLineCheckbox').checked = nowLinePref === null ? true : nowLinePref === 'true';
        
        document.getElementById('actionRangeInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') document.getElementById('btnActionConfirm').click(); });
        document.getElementById('editInitInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') document.getElementById('btnEditConfirm').click(); });
        document.getElementById('editStartInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') document.getElementById('btnEditConfirm').click(); });
        document.getElementById('editDurInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') document.getElementById('btnEditConfirm').click(); });
        document.getElementById('multiInitials').addEventListener('keypress', (e) => { if(e.key === 'Enter') saveShift(); });

        initHeader(); 
        loadDateData(); 
    };

    function toggleDaySupPreference() {
        const isChecked = document.getElementById('daySupCheckbox').checked;
        localStorage.setItem(`day_sup_checked_${document.getElementById('targetDate').value}`, isChecked);
        render();
    }

    function toggleNowLinePreference() {
        const isChecked = document.getElementById('showNowLineCheckbox').checked;
        localStorage.setItem('show_now_line', isChecked);
        updateNowLine();
        render();
    }

    function saveHistory() {
        historyStack.push(JSON.stringify(shifts));
        redoStack = []; 
        if (historyStack.length > 30) historyStack.shift();
        updateUndoRedoUI();
    }

    function updateUndoRedoUI() {
        document.getElementById('undoBtn').disabled = (historyStack.length === 0);
        document.getElementById('redoBtn').disabled = (redoStack.length === 0);
    }

    function undo() {
        if (historyStack.length > 0) {
            redoStack.push(JSON.stringify(shifts));
            shifts = JSON.parse(historyStack.pop());
            updateUndoRedoUI();
            renderUIOnly();
        }
    }

    function redo() {
        if (redoStack.length > 0) {
            historyStack.push(JSON.stringify(shifts));
            shifts = JSON.parse(redoStack.pop());
            updateUndoRedoUI();
            renderUIOnly();
        }
    }

    function enableDraftMode() {
        if (isDraft) return;
        isDraft = true;
        document.getElementById('bigDraftWarning').style.display = 'block';
        document.getElementById('timelineContainer').classList.add('is-draft-mode');
        document.getElementById('btnCreateDraft').style.display = 'none';
        document.getElementById('btnCommitDraft').style.display = 'block';
        document.getElementById('btnClearDraft').style.display = 'block';
        render();
    }

    function commitDraft() {
        if(confirm("Commit draft and overwrite original?")) {
            saveHistory();
            isDraft = false;
            document.getElementById('timelineContainer').classList.remove('is-draft-mode');
            finishUpdate();
            document.getElementById('bigDraftWarning').style.display = 'none';
            document.getElementById('btnCreateDraft').style.display = 'block';
            document.getElementById('btnCommitDraft').style.display = 'none';
            document.getElementById('btnClearDraft').style.display = 'none';
        }
    }

    function clearDraft() {
        isDraft = false;
        document.getElementById('timelineContainer').classList.remove('is-draft-mode');
        document.getElementById('bigDraftWarning').style.display = 'none';
        document.getElementById('btnCreateDraft').style.display = 'block';
        document.getElementById('btnCommitDraft').style.display = 'none';
        document.getElementById('btnClearDraft').style.display = 'none';
        loadDateData();
    }

    function togglePaste(show) { 
        const overlay = document.getElementById('pasteOverlay');
        overlay.style.display = show ? 'flex' : 'none'; 
        if(show) {
            document.getElementById('modalDaySup').checked = document.getElementById('daySupCheckbox').checked;
            document.getElementById('modalDraftMode').checked = isDraft;
            toggleModalDraftWarning();
            setTimeout(() => document.getElementById('bulkPasteInput').focus(), 50);
        }
    }

    function toggleModalDraftWarning() {
        const isChecked = document.getElementById('modalDraftMode').checked;
        document.getElementById('modalDraftWarning').style.visibility = isChecked ? 'visible' : 'hidden';
        if(isChecked) document.getElementById('bulkPasteInput').focus();
    }

    function toggleTrainees(show) {
        const overlay = document.getElementById('traineeOverlay');
        overlay.style.display = show ? 'flex' : 'none';
        if(show) {
            const stored = localStorage.getItem('trainee_registry') || "";
            document.getElementById('traineeInput').value = stored;
            setTimeout(() => document.getElementById('traineeInput').focus(), 50);
        }
    }

    function saveTrainees() {
        const val = document.getElementById('traineeInput').value.toUpperCase();
        localStorage.setItem('trainee_registry', val);
        toggleTrainees(false);
        render();
    }

    function getNowData() {
        const now = new Date();
        const hours = now.getHours();
        const mins = now.getMinutes();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        
        let dashboardDateStr = `${year}-${month}-${day}`;
        let relHour = hours + (mins / 60);

        if (hours >= 0 && hours < 3) {
            const yesterday = new Date(now);
            yesterday.setDate(now.getDate() - 1);
            dashboardDateStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;
            relHour += 24;
        }

        const offset = relHour - START_HOUR;
        return { dashboardDateStr, offset, isSuppressed: (hours >= 3 && hours < 5) };
    }

    function updateNowLine() {
        const line = document.getElementById('nowLine');
        const showLinePref = document.getElementById('showNowLineCheckbox').checked;
        const targetDashboardDate = document.getElementById('targetDate').value;
        
        const nowInfo = getNowData();

        if (showLinePref && !nowInfo.isSuppressed && targetDashboardDate === nowInfo.dashboardDateStr && nowInfo.offset >= 0 && nowInfo.offset <= TOTAL_HOURS) {
            line.style.display = 'block';
            line.style.left = (nowInfo.offset / TOTAL_HOURS * 100) + '%';
        } else { 
            line.style.display = 'none'; 
        }
    }
    setInterval(() => { updateNowLine(); render(); }, 60000);

    function processPaste(type) {
        if (document.getElementById('modalDraftMode').checked) enableDraftMode();
        saveHistory();
        const rawText = document.getElementById('bulkPasteInput').value;
        
        if (type === 'schedule') {
            const lines = rawText.split('\n');
            const isChecked = document.getElementById('modalDaySup').checked;
            document.getElementById('daySupCheckbox').checked = isChecked;
            localStorage.setItem(`day_sup_checked_${document.getElementById('targetDate').value}`, isChecked);
            let incomingParsedShifts = [];
            let currentTime = "", currentDuration = 8;
            lines.forEach(line => {
                const cleanLine = line.trim(); if (!cleanLine) return;
                const timeMatch = cleanLine.match(/(\d{1,2})?(\d{2}(00|30|45))/);
                if (timeMatch) {
                    currentTime = timeMatch[0].slice(-4);
                    const durMatch = cleanLine.match(/-(6|7|9|10|12)/);
                    currentDuration = durMatch ? parseInt(durMatch[1]) : 8; return;
                }
                const initialsRegex = /([A-Z]{2,3}\$?)/g; let match;
                while ((match = initialsRegex.exec(cleanLine)) !== null) {
                    if (currentTime) incomingParsedShifts.push({ initials: match[1].replace('$', ''), startRaw: currentTime, duration: currentDuration });
                }
            });

            incomingParsedShifts.forEach(incoming => {
                const iStart = parseTimeInput(incoming.startRaw);
                let matched = false;
                for (let existing of shifts) {
                    if (existing.initials === incoming.initials && existing.startRaw === incoming.startRaw && existing.duration === incoming.duration) {
                        matched = true; break;
                    }
                    if (existing.initials === incoming.initials) {
                        const eStart = parseTimeInput(existing.startRaw);
                        const gapHours = Math.abs(iStart - (eStart + existing.duration));
                        if (gapHours < 10) {
                            existing.startRaw = incoming.startRaw;
                            existing.duration = incoming.duration;
                            matched = true; break;
                        }
                    }
                }
                if (!matched) shifts.push({ initials: incoming.initials, startRaw: incoming.startRaw, duration: incoming.duration, leave: [], pendingLeave: [], xte: [], status: 'active', asStaff: false, trainer: '', pendingImport: [] });
            });
        } else {
            let initialsInPaste = new Set();
            let newImportItems = [];
            let pasteCounter = 0;

            // v13.6 ROBUST ROW PARSER
            const typeKeywords = ["Annual", "Sick", "Shift Chg", "XTU", "Holiday", "Admin", "Furlough", "FSL", "HL", "AL", "SL"];
            const statusKeywords = ["Approved!", "Pending", "Denied"];
            const timePatterns = /Shift|X|HL|([A-Z]{1,2})?\d{2,4}(-\d+)?|(\d{1,2}:\d{2})/gi;

            // Anchor logic: Find every instance of CPC (2 chars) followed immediately by a Type
            const masterRowFinder = new RegExp(`([A-Z]{2})(${typeKeywords.join('|')})`, 'gi');
            let rowMatch;
            let rowStarts = [];
            while ((rowMatch = masterRowFinder.exec(rawText)) !== null) {
                rowStarts.push({ index: rowMatch.index, cpc: rowMatch[1].toUpperCase(), type: rowMatch[2] });
            }

            for (let i = 0; i < rowStarts.length; i++) {
                let current = rowStarts[i];
                let nextIndex = rowStarts[i+1] ? rowStarts[i+1].index : rawText.length;
                let segment = rawText.substring(current.index, nextIndex);

                const statusMatch = segment.match(new RegExp(statusKeywords.join('|'), 'i'));
                if (!statusMatch) continue;

                let statusStrRaw = statusMatch[0].toUpperCase();
                let subSegment = segment.substring(0, segment.indexOf(statusMatch[0]));

                let values = subSegment.match(timePatterns) || [];
                let fromRaw = values.find(v => v.toUpperCase() !== current.type.toUpperCase() && v.length > 0) || "";
                let toRaw = (fromRaw.toLowerCase() === "shift") ? "" : (values.filter(v => v !== fromRaw && v.toUpperCase() !== current.type.toUpperCase())[0] || "");

                initialsInPaste.add(current.cpc);
                pasteCounter++;
                let finalType = current.type.toUpperCase().replace("ANNUAL","AL").replace("SICK","SL").replace("HOLIDAY","HL").replace("ADMIN","Admin");
                newImportItems.push({ cpc: current.cpc, type: finalType, from: fromRaw, to: toRaw, status: statusStrRaw, pasteOrder: pasteCounter });
            }

            initialsInPaste.forEach(initial => {
                let existingShift = shifts.find(s => s.initials === initial);
                if (existingShift) { existingShift.pendingImport = []; }
                else { shifts.push({ initials: initial, startRaw: '0000', duration: 0, leave: [], pendingLeave: [], xte: [], status: 'inactive', asStaff: false, trainer: '', pendingImport: [], isGhost: true }); }
            });

            newImportItems.forEach(ni => {
                let targetShift = shifts.find(s => s.initials === ni.cpc);
                if (ni.status.includes("PENDING") || ni.status.includes("DENIED")) {
                    targetShift.pendingImport.push({ ...ni, processed: false });
                } else if (ni.status.includes("APPROVED")) {
                    if (LEAVE_TYPES.includes(ni.type.toUpperCase()) && ni.from.toLowerCase() === "shift") {
                        shifts = shifts.filter(s => s !== targetShift);
                        return;
                    }
                    if (OFF_TYPES.includes(ni.from.toUpperCase())) return; 
                    if (ni.from.toLowerCase() === "shift" && !targetShift.isGhost) {
                        const sStart = parseTimeInput(targetShift.startRaw);
                        ni.from = formatTimeFromOffset(sStart); ni.to = formatTimeFromOffset(sStart + targetShift.duration);
                    }
                    targetShift.leave.push({ startRaw: ni.from.replace(':',''), endRaw: ni.to.replace(':',''), type: ni.type });
                }
            });
        }
        document.getElementById('bulkPasteInput').value = ''; finishUpdate(); togglePaste(false);
    }

    function handleImportAction(shiftIdx, piIdx, action) {
        saveHistory();
        const s = shifts[shiftIdx];
        const row = s.pendingImport[piIdx];
        
        if (action === 'approve') {
            row.processed = true; 
            row.origStart = s.startRaw;
            row.origDur = s.duration;

            if (LEAVE_TYPES.includes(row.type.toUpperCase()) && row.from.toLowerCase() === "shift") {
                shifts.splice(shiftIdx, 1);
                finishUpdate();
                return;
            }

            if (row.type === "SHIFT CHG") {
                let timeStr = row.to.replace(':','');
                let newStart = timeStr, newDur = 8;
                if (timeStr.includes('-')) { 
                    const parts = timeStr.split('-'); 
                    newStart = parts[0]; 
                    newDur = parseFloat(parts[1]); 
                }
                s.startRaw = newStart; 
                s.duration = newDur;
                s.status = 'active'; 
                s.isGhost = false;
            } else { 
                const fromRaw = (OFF_TYPES.includes(row.from.toUpperCase())) ? s.startRaw : row.from.replace(':', '');
                const toRaw = row.to.replace(':', '');
                if (!s.leave) s.leave = [];
                s.leave.push({ startRaw: fromRaw, endRaw: toRaw, type: row.type });
            }
        } else if (action === 'revert') {
            row.processed = false;
            if (row.type === "SHIFT CHG") {
                s.startRaw = row.origStart || '0000';
                s.duration = row.origDur || 0;
                if(s.isGhost && s.duration === 0) s.status = 'inactive';
            } else { 
                const reqStart = (OFF_TYPES.includes(row.from.toUpperCase()) || row.from.toLowerCase() === "shift") ? row.origStart : row.from.replace(':', '');
                const reqEnd = row.to.replace(':', '');
                s.leave = (s.leave || []).filter(lv => !(lv.startRaw === reqStart && lv.endRaw === reqEnd && lv.type === row.type));
            }
        } else if (action === 'reject') { 
            if (row.processed) handleImportAction(shiftIdx, piIdx, 'revert'); 
            s.pendingImport.splice(piIdx, 1); 
        }
        finishUpdate();
    }

    function initHeader() {
        const labels = document.getElementById('hourLabels'), capRow = document.getElementById('capacityRow');
        labels.innerHTML = ''; capRow.innerHTML = '';
        for (let i = 0; i < TOTAL_HOURS; i++) {
            const h = (START_HOUR + i) % 24;
            labels.innerHTML += `<div class="hour-label">${h.toString().padStart(2, '0')}00</div>`;
            capRow.innerHTML += `<div class="cap-cell" id="cap-${i}">0</div>`;
        }
    }

    function loadDateData() {
        const dateVal = document.getElementById('targetDate').value;
        const key = `staff_data_${dateVal}`, dateKey = `day_sup_checked_${dateVal}`;
        document.getElementById('daySupCheckbox').checked = localStorage.getItem(dateKey) === 'true'; 
        document.getElementById('printInfo').innerText = dateVal ? new Date(dateVal + 'T00:00:00').toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : "No Date Selected";
        shifts = JSON.parse(localStorage.getItem(key)) || [];
        render();
    }
    
    function parseTimeInput(val) {
        if(!val || OFF_TYPES.includes(val.toUpperCase()) || val.toLowerCase() === 'shift') return 0;
        let cleaned = val.toString().replace(':', '').split('-')[0];
        if (cleaned.length < 3) return 0;
        let h = parseInt(cleaned.substring(0, cleaned.length - 2)), m = parseInt(cleaned.substring(cleaned.length - 2));
        let rel = h + (m / 60); if (h < START_HOUR) rel += 24;
        return rel - START_HOUR;
    }
    
    function formatTimeFromOffset(offset) {
        let totalHours = (offset + START_HOUR) % 24, h = Math.floor(totalHours), m = Math.round((totalHours - h) * 60);
        return h.toString().padStart(2, '0') + m.toString().padStart(2, '0');
    }

    function saveShift() {
        saveHistory();
        const input = document.getElementById('multiInitials').value.trim();
        const startRaw = document.getElementById('startTime').value, duration = parseFloat(document.getElementById('duration').value);
        if (input) { input.split(/\s+/).forEach(init => { shifts.push({ initials: init.toUpperCase(), startRaw, duration, leave: [], pendingLeave: [], xte: [], status: 'active', asStaff: false, trainer: '', pendingImport: [] }); }); finishUpdate(); document.getElementById('multiInitials').value = ''; document.getElementById('startTime').value = ''; }
    }

    function toggleStatus(idx, val) { saveHistory(); shifts[idx].status = val; finishUpdate(); }
    function toggleAsStaff(idx, val) { saveHistory(); shifts[idx].asStaff = val; finishUpdate(); }
    function setTrainer(idx, val) { saveHistory(); shifts[idx].trainer = val; finishUpdate(); }
    function finishUpdate() { if (!isDraft) localStorage.setItem(`staff_data_${document.getElementById('targetDate').value}`, JSON.stringify(shifts)); render(); }
    function renderUIOnly() { if (!isDraft) localStorage.setItem(`staff_data_${document.getElementById('targetDate').value}`, JSON.stringify(shifts)); render(); }

    function openActionModal(type, idx) {
        const overlay = document.getElementById('actionOverlay'), input = document.getElementById('actionRangeInput'), confirmBtn = document.getElementById('btnActionConfirm');
        const s = shifts[idx];
        const sStart = parseTimeInput(s.startRaw), sEnd = sStart + s.duration;
        overlay.style.display = 'flex'; 
        document.getElementById('actionTitle').innerText = type === 'leave' ? 'Add Leave' : 'Add XTE';
        document.getElementById('actionSubtext').innerHTML = `Add ${type.toUpperCase()} for <b>${s.initials}</b><br><small>Shift: ${formatTimeFromOffset(sStart)} - ${formatTimeFromOffset(sEnd)}</small>`; 
        input.value = ''; input.focus();
        confirmBtn.onclick = () => { 
            const r = input.value; 
            if (r && r.includes('-')) { 
                const [st, en] = r.split('-'), cleanSt = st.trim().padStart(4,'0'), cleanEn = en.trim().padStart(4,'0'); 
                saveHistory(); 
                if(type === 'leave') s.leave.push({ startRaw: cleanSt, endRaw: cleanEn, type: 'LV' }); 
                else { if(!s.xte) s.xte = []; s.xte.push({ startRaw: cleanSt, endRaw: cleanEn }); } 
                finishUpdate(); closeActionModal(); 
            } 
        };
    }

    function openEditModal(idx) {
        const overlay = document.getElementById('editOverlay'), initInput = document.getElementById('editInitInput'), startInput = document.getElementById('editStartInput'), durInput = document.getElementById('editDurInput'), container = document.getElementById('editSubItemsContainer');
        const s = shifts[idx];
        const sStart = parseTimeInput(s.startRaw), sEnd = sStart + s.duration;
        overlay.style.display = 'flex'; 
        initInput.value = s.initials; 
        startInput.value = s.startRaw; 
        durInput.value = s.duration; 
        document.getElementById('editSubtext').innerHTML = `<small>Current: ${formatTimeFromOffset(sStart)} - ${formatTimeFromOffset(sEnd)} (${s.duration}hr)</small>`;
        container.innerHTML = '';
        const buildRow = (type, item, i) => { 
            const div = document.createElement('div'); div.className = 'sub-edit-row'; 
            div.innerHTML = `<span class="sub-edit-label">${type.toUpperCase()}</span><input type="text" class="sub-edit-input" data-type="${type}" data-index="${i}" data-field="start" value="${item.startRaw}" style="width: 50px;"><span>to</span><input type="text" class="sub-edit-input" data-type="${type}" data-index="${i}" data-field="end" value="${item.endRaw}" style="width: 50px;">`; 
            div.querySelectorAll('input').forEach(inp => inp.addEventListener('keypress', (e) => { if(e.key === 'Enter') document.getElementById('btnEditConfirm').click(); }));
            return div; 
        };
        if(s.leave) s.leave.forEach((lv, i) => container.appendChild(buildRow('leave', lv, i)));
        if(s.xte) s.xte.forEach((xt, i) => container.appendChild(buildRow('xte', xt, i)));
        initInput.focus();
        document.getElementById('btnEditConfirm').onclick = () => { saveHistory(); s.initials = initInput.value.toUpperCase(); s.startRaw = startInput.value.trim(); s.duration = parseFloat(durInput.value); container.querySelectorAll('.sub-edit-input').forEach(input => { const type = input.dataset.type, i = parseInt(input.dataset.index), field = input.dataset.field, val = input.value.trim().padStart(4, '0'); if(type === 'leave') { if(field === 'start') s.leave[i].startRaw = val; else s.leave[i].endRaw = val; } else { if(field === 'start') s.xte[i].startRaw = val; else s.xte[i].endRaw = val; } }); finishUpdate(); closeEditModal(); };
    }

    function render() {
        const chart = document.getElementById('chartArea'), list = document.getElementById('shiftList'), importList = document.getElementById('pendingImportItems');
        chart.innerHTML = ''; list.innerHTML = ''; importList.innerHTML = '';
        const counts = new Array(TOTAL_HOURS).fill(0);
        const traineeReg = (localStorage.getItem('trainee_registry') || "").split(/\s+/).filter(Boolean);
        const targetDateVal = document.getElementById('targetDate').value;
        const dayOfWeek = targetDateVal ? new Date(targetDateVal + 'T00:00:00').getDay() : null; 
        const isSunFri = (dayOfWeek !== null && dayOfWeek !== 6), isSat = (dayOfWeek === 6), supChecked = document.getElementById('daySupCheckbox').checked, showNowLinePref = document.getElementById('showNowLineCheckbox').checked;

        const nowInfo = getNowData();

        let sortedShifts = [...shifts].sort((a,b) => parseTimeInput(a.startRaw) - parseTimeInput(b.startRaw));
        let finalDisplayOrder = []; let handledIndices = new Set();
        sortedShifts.forEach((s) => {
            const originalIdx = shifts.indexOf(s);
            if (handledIndices.has(originalIdx) || s.duration <= 0) return;
            if (s.trainer && traineeReg.includes(s.initials) && !s.asStaff && shifts.some(sh => sh.initials === s.trainer)) return;
            finalDisplayOrder.push(s); handledIndices.add(originalIdx);
            sortedShifts.forEach((traineeCand) => {
                const tIdx = shifts.indexOf(traineeCand);
                if (!handledIndices.has(tIdx) && traineeCand.trainer === s.initials && traineeReg.includes(traineeCand.initials) && !traineeCand.asStaff) { finalDisplayOrder.push(traineeCand); handledIndices.add(tIdx); }
            });
        });
        sortedShifts.forEach((s) => { if (!handledIndices.has(shifts.indexOf(s)) && s.duration > 0) finalDisplayOrder.push(s); });

        let allPending = [];
        shifts.forEach((s, sIdx) => { if (s.pendingImport) { s.pendingImport.forEach((pi, piIdx) => { allPending.push({ ...pi, sIdx, piIdx }); }); } });
        allPending.sort((a, b) => a.pasteOrder - b.pasteOrder);

        finalDisplayOrder.forEach((s) => {
            let baseStartOff = parseTimeInput(s.startRaw), baseEndOff = baseStartOff + s.duration;
            let overallStartOff = baseStartOff, overallEndOff = baseEndOff;
            const isFullShiftLeave = (s.leave || []).some(lv => {
                const lvS = parseTimeInput(lv.startRaw), lvE = parseTimeInput(lv.endRaw);
                return Math.abs(lvS - baseStartOff) < 0.1 && Math.abs(lvE - baseEndOff) < 0.1;
            });
            if (isFullShiftLeave) return;
            (s.xte || []).forEach(xt => { let xtS = parseTimeInput(xt.startRaw), xtE = parseTimeInput(xt.endRaw); overallStartOff = Math.min(overallStartOff, xtS); overallEndOff = Math.max(overallEndOff, xtE); });
            const isTrainee = traineeReg.includes(s.initials) && !s.asStaff;
            
            const isGreyedOut = showNowLinePref && (targetDateVal === nowInfo.dashboardDateStr) && (nowInfo.offset >= overallEndOff);

            if (s.status !== 'inactive' && !isTrainee) { for(let h=0; h<TOTAL_HOURS; h++) { const isLeave = (s.leave || []).some(lv => Math.max(parseTimeInput(lv.startRaw), h) < Math.min(parseTimeInput(lv.endRaw), h+1)); if(Math.max(overallStartOff, h) < Math.min(overallEndOff, h+1) && !isLeave && !((h+START_HOUR)%24 < 20 && h >= (overallEndOff - 1))) counts[h]++; } }
            let visualDuration = Math.min(overallEndOff, TOTAL_HOURS) - overallStartOff;
            if (visualDuration > 0) {
                const row = document.createElement('div'); row.className = 'shift-row'; 
                const bar = document.createElement('div');
                bar.className = `shift-bar ${isTrainee ? 'trainee-bar' : ''} ${isGreyedOut || s.status === 'inactive' ? 'inactive-bar' : ''}`;
                bar.style.left = (overallStartOff / TOTAL_HOURS * 100) + '%';
                bar.style.width = (visualDuration / TOTAL_HOURS * 100) + '%';
                bar.innerHTML = `<span class="bar-text">${s.initials} ${formatTimeFromOffset(overallStartOff)}-${formatTimeFromOffset(overallEndOff)} (${overallEndOff - overallStartOff}hr)</span>`;
                if (!isGreyedOut) {
                    shifts.forEach(traineeShift => { if (traineeShift.trainer === s.initials && traineeReg.includes(traineeShift.initials) && !traineeShift.asStaff) { const tStart = parseTimeInput(traineeShift.startRaw), overlapStart = Math.max(overallStartOff, tStart), overlapEnd = Math.min(overallEndOff, tStart + traineeShift.duration); if (overlapEnd > overlapStart) { const stripe = document.createElement('div'); stripe.className = 'training-overlap-overlay'; stripe.style.left = ((overlapStart - overallStartOff) / visualDuration * 100) + '%'; stripe.style.width = ((overlapEnd - overlapStart) / visualDuration * 100) + '%'; bar.appendChild(stripe); } } });
                }
                (s.xte || []).forEach(xt => { const xtS = parseTimeInput(xt.startRaw), xtE = parseTimeInput(xt.endRaw); const xOver = document.createElement('div'); xOver.className = 'xte-overlay'; xOver.style.left = ((xtS - overallStartOff) / visualDuration * 100) + '%'; xOver.style.width = ((Math.min(xtE, overallEndOff) - xtS) / visualDuration * 100) + '%'; xOver.innerText = `XTE ${xt.startRaw}-${xt.endRaw}`; bar.appendChild(xOver); });
                if (s.status !== 'inactive' && !isTrainee) {
                    let hSlot = baseEndOff - 1;
                    const lvEnd = (s.leave || []).find(lv => Math.abs(parseTimeInput(lv.endRaw) - baseEndOff) <= 1 && ["AL", "SL", "HL", "Admin", "XTU", "FURLOUGH", "LV"].includes(lv.type));
                    const hasXTEAtEnd = (s.xte || []).some(xt => Math.abs(parseTimeInput(xt.startRaw) - baseEndOff) < 0.1);
                    if (lvEnd) hSlot = parseTimeInput(lvEnd.startRaw) - 1;
                    if (!(overallEndOff > 17 || (parseInt(formatTimeFromOffset(overallEndOff)) >= 300 && parseInt(formatTimeFromOffset(overallEndOff)) <= 800)) && !hasXTEAtEnd && !isGreyedOut) {
                        let hOver = document.createElement('div'); hOver.className = 'handover-overlay'; hOver.style.left = ((hSlot - overallStartOff) / visualDuration * 100) + '%'; hOver.style.width = (1 / visualDuration * 100) + '%'; bar.appendChild(hOver); 
                    }
                }
                (s.leave || []).forEach(lv => { const lvS = parseTimeInput(lv.startRaw), lvE = parseTimeInput(lv.endRaw); const lOver = document.createElement('div'); lOver.className = `leave-overlay`; lOver.style.left = ((lvS - overallStartOff) / visualDuration * 100) + '%'; lOver.style.width = ((Math.min(lvE, overallEndOff) - lvS) / visualDuration * 100) + '%'; lOver.innerText = `${lv.type} ${lv.startRaw}-${lv.endRaw}`; bar.appendChild(lOver); });
                row.appendChild(bar); chart.appendChild(row);
            }
        });

        shifts.forEach((s, originalIdx) => {
            if (s.isGhost && (!s.pendingImport || s.pendingImport.length === 0)) return;
            const oS = parseTimeInput(s.startRaw), oE = oS + s.duration, isTInReg = traineeReg.includes(s.initials);
            let tags = (s.leave || []).map((lv, i) => `<div class="registry-leave-tag">${lv.type} ${lv.startRaw}-${lv.endRaw} <button class="btn-del-leave" onclick="deleteLeave(${originalIdx}, ${i})"></button></div>`).join('') + (s.xte || []).map((xt, i) => `<div class="registry-leave-tag tag-xte">XTE ${xt.startRaw}-${xt.endRaw} <button class="btn-del-leave" onclick="deleteXte(${originalIdx}, ${i})"></button></div>`).join('') + (s.pendingLeave || []).map((lv, i) => `<div class="registry-leave-tag tag-pending">${lv.type} ${lv.startRaw}-${lv.endRaw} <button class="btn-accept-leave" onclick="acceptPendingLeave(${originalIdx}, ${i})"></button><button class="btn-del-leave" onclick="rejectPendingLeave(${originalIdx}, ${i})"></button></div>`).join('');
            let trC = ''; staffingCheck = '';
            if (isTInReg) {
                if (!s.asStaff) {
                    const potentialTrainers = shifts.filter(o => o.initials !== s.initials && (!traineeReg.includes(o.initials) || o.asStaff));
                    trC = `<div style="margin-top: 5px; display: flex; flex-direction: column; gap: 4px;"><label style="font-size: 9px; font-weight: bold;">TRAINER</label><select class="trainer-select" onchange="setTrainer(${originalIdx}, this.value)"><option value="">None</option>${potentialTrainers.map(o => `<option value="${o.initials}" ${s.trainer === o.initials ? 'selected' : ''}>${o.initials}</option>`).join('')}</select></div>`;
                }
                staffingCheck = `<label style="font-size: 10px; display: flex; align-items: center; gap: 4px; cursor: pointer; margin-top: 5px;"><input type="checkbox" style="width:12px; height:12px;" ${s.asStaff ? 'checked' : ''} onchange="toggleAsStaff(${originalIdx}, this.checked)"> Staffing</label>`;
            }
            const itemClass = isTInReg && !s.asStaff ? 'list-item is-trainee-item' : 'list-item';
            const traineeBarStyle = isTInReg ? 'border-left: 4px solid var(--trainee);' : '';
            const shiftInfo = s.isGhost ? 'NOT ON SHIFT' : `${formatTimeFromOffset(oS)}-${formatTimeFromOffset(oE)} (${s.duration}hr)`;
            list.innerHTML += `<div class="${itemClass}" style="${traineeBarStyle}"><div style="display:flex; justify-content:space-between; align-items:flex-start;"><div><b>${s.initials}</b><span class="registry-shift-info">${shiftInfo}</span>${trC}</div><div style="display: flex; flex-direction: column; align-items: flex-end; width: 85px;"><select class="status-select" onchange="toggleStatus(${originalIdx}, this.value)"><option value="active" ${s.status === 'active' ? 'selected' : ''}>Active</option><option value="inactive" ${s.status === 'inactive' ? 'selected' : ''}>Inactive</option></select>${staffingCheck}</div></div><div class="registry-leave-container">${tags}</div><div class="item-actions"><button class="btn-leave" onclick="openActionModal('leave', ${originalIdx})">+ Leave</button><button class="btn-xte" onclick="openActionModal('xte', ${originalIdx})">+ XTE</button><button class="btn-edit" onclick="openEditModal(${originalIdx})">Edit</button><button class="btn-del" onclick="deleteShift(${originalIdx})">Del</button></div></div>`;
        });

        allPending.forEach((pi) => {
            const isDenied = pi.status.toLowerCase().includes('denied');
            const deniedTag = isDenied ? ' <span style="color: #e74c3c; font-weight: bold;">DENIED</span>' : '';
            const mainAction = pi.processed ? `<button class="btn-revert-leave" title="Undo" onclick="handleImportAction(${pi.sIdx}, ${pi.piIdx}, 'revert')"></button>` : `<button class="btn-accept-leave" onclick="handleImportAction(${pi.sIdx}, ${pi.piIdx}, 'approve')"></button>`;
            
            let timeDisplay = "";
            if (pi.type === "SHIFT CHG") {
                timeDisplay = `From ${pi.from} To ${pi.to}`;
            } else if (pi.from.toLowerCase() === "shift") {
                timeDisplay = "Shift";
            } else {
                timeDisplay = `${pi.from}${pi.to ? ' to ' + pi.to : ''}`;
            }
            
            importList.innerHTML += `<div class="pending-import-item ${pi.processed ? 'processed' : ''}"><div class="pending-import-data"><b>${pi.cpc}</b>: ${pi.type}${deniedTag}<br>${timeDisplay}</div><div class="pending-import-actions">${mainAction}<button class="btn-del-leave" style="color: red; font-size: 14px;" onclick="handleImportAction(${pi.sIdx}, ${pi.piIdx}, 'reject')"></button></div></div>`;
        });
        
        counts.forEach((c, i) => { 
            const cell = document.getElementById(`cap-${i}`); cell.innerText = c || '-'; cell.className = 'cap-cell'; 
            const h = (i + START_HOUR) % 24; let match = false;
            if (isSunFri && h === 6) { cell.classList.add((supChecked ? c >= 3 : c >= 4) ? 'cap-green' : 'cap-red'); match = true; } 
            else if (isSunFri && [20, 21, 22].includes(h)) { cell.classList.add(c >= (h===20?8:h===21?5:3) ? 'cap-green' : 'cap-red'); match = true; } 
            else if (isSat && h === 21) { cell.classList.add(c >= 5 ? 'cap-green' : 'cap-red'); match = true; }
            if (!match && h >= 7 && h <= 20) { if (c <= 5) cell.classList.add('cap-red'); else if (c === 6) cell.classList.add('cap-yellow'); }
        });
        updateNowLine();
    }

    function deleteLeave(si, li) { saveHistory(); shifts[si].leave.splice(li, 1); finishUpdate(); }
    function deleteXte(si, xi) { if(!shifts[si].xte) shifts[si].xte = []; saveHistory(); shifts[si].xte.splice(xi, 1); finishUpdate(); }
    function deleteShift(i) { if(confirm("Delete?")) { saveHistory(); shifts.splice(i, 1); finishUpdate(); } }
    function clearAllShifts() { if(confirm("Clear ALL?")) { saveHistory(); shifts = []; finishUpdate(); } }
    function closeActionModal() { document.getElementById('actionOverlay').style.display = 'none'; }
    function closeEditModal() { document.getElementById('editOverlay').style.display = 'none'; }
    initHeader(); loadDateData();
</script>
</body>
</html>
