<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Graph - Organized Pending List</title>
    <style>
        :root {
            --grid-border: #d1d5db;
            --line-color: #e5e7eb;
            --bar-color: #93c5fd; 
            --bar-text: #1e3a8a;  
            --trainee-color: #d8b4fe;
            --trainee-text: #581c87;
            --trainee-bg-light: #f5f3ff;
            --handover-yellow: #fef08a; 
            --alert-light-yellow: #fef9c3; 
            --danger-red: #fee2e2; 
            --sidebar-bg: #ffffff;
            --header-bg: #f3f4f6;
            --tag-pending: #ffedd5;
            --tag-pending-text: #9a3412;
            --tag-denied: #fee2e2;
            --tag-denied-text: #991b1b;
            --preview-green: #22c55e;
            --commit-blue: #0ea5e9;
            --inactive-gray: #9ca3af;
        }

        body, html { height: 100%; margin: 0; font-family: 'Inter', system-ui, sans-serif; background-color: #f9fafb; overflow: hidden; }
        .app-wrapper { display: flex; flex-direction: column; height: 100vh; padding: 8px; box-sizing: border-box; position: relative; }
        .controls { display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; flex-shrink: 0; gap: 10px; }
        .controls-left { display: flex; align-items: center; gap: 8px; }
        .controls-right { display: flex; gap: 6px; align-items: center; }
        input[type="date"], input[type="text"], input[type="number"], select { padding: 5px; border: 1px solid var(--grid-border); border-radius: 6px; font-size: 0.85rem; }
        
        button { padding: 6px 12px; background-color: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        .btn-undo, .btn-redo { background-color: #64748b; }
        .btn-clear { background-color: #ef4444; }
        .btn-manual { background-color: #10b981; }
        .btn-action { font-size: 0.65rem; padding: 4px 8px; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 700; text-transform: uppercase; }
        .btn-edit { background-color: #f59e0b; }

        .main-layout { display: flex; flex-grow: 1; gap: 8px; overflow: hidden; min-height: 0; }
        .graph-container { flex-grow: 1; background: white; border: 1px solid var(--grid-border); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        .grid-header { display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; background: white; border-bottom: 1px solid var(--grid-border); }
        .time-labels { display: grid; grid-template-columns: repeat(24, 1fr); width: 100%; height: 24px; background: var(--header-bg); align-items: center; transform: translateX(calc(-100% / 48)); }
        .time-labels span { font-size: 0.65rem; font-weight: 600; color: #6b7280; text-align: center; }
        
        .coverage-counts { display: grid; grid-template-columns: repeat(24, 1fr); height: 24px; background: #eff6ff; align-items: center; }
        .coverage-counts span { font-size: 0.75rem; font-weight: 900; color: var(--bar-text); text-align: center; height: 100%; display: flex; align-items: center; justify-content: center; border-right: 1px solid rgba(209, 213, 219, 0.3); }
        .count-warning { background-color: var(--alert-light-yellow) !important; color: #92400e !important; } 
        .count-danger { background-color: var(--danger-red) !important; color: #b91c1c !important; } 

        .grid-scroll-area { flex-grow: 1; overflow-y: auto; position: relative; min-height: 0; }
        .schedule-grid { display: flex; flex-direction: column; min-height: 100%; position: relative; background-image: linear-gradient(to right, var(--line-color) 1px, transparent 1px); background-size: calc(100% / 24) 100%; }
        
        #now-line { position: absolute; top: 0; bottom: 0; width: 2px; background-color: #ef4444; z-index: 100; pointer-events: none; display: none; }

        .shift-track { display: grid; grid-template-columns: repeat(1440, 1fr); height: 32px; align-items: center; border-bottom: 1px solid #f3f4f6; }
        .shift-bar { background-color: var(--bar-color); color: var(--bar-text); height: 22px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; z-index: 10; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1); overflow: hidden; white-space: nowrap; gap: 6px; position: relative; font-weight: bold; }
        .bar-trainee { background-color: var(--trainee-color) !important; color: var(--trainee-text) !important; }
        .bar-inactive { background-color: var(--inactive-gray) !important; opacity: 0.6; }

        .overlay-segment { position: absolute; top: 0; height: 100%; pointer-events: none; }
        .trainer-stripes-overlay { background-image: repeating-linear-gradient(45deg, rgba(107, 33, 168, 0.6), rgba(107, 33, 168, 0.6) 10px, transparent 10px, transparent 20px); z-index: 2; }
        .yellow-bar-overlay { background-color: var(--handover-yellow); z-index: 3; }
        .xte-segment { background-color: var(--xte-green); color: #1e3a8a; z-index: 4; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; font-weight: 800; border-radius: 2px; }
        .leave-segment { background-color: var(--leave-gray); color: white; z-index: 5; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; }

        .preview-new { border: 2px solid var(--preview-green) !important; box-shadow: 0 0 8px rgba(34, 197, 94, 0.6); z-index: 15 !important; }
        .preview-replaced { background-color: rgba(147, 197, 253, 0.1) !important; border: 2px dashed #2563eb !important; color: #2563eb !important; opacity: 0.5; z-index: 5 !important; }

        .bar-content-text { position: relative; z-index: 10; padding: 0 4px; }

        .sidebar { width: 280px; background: var(--sidebar-bg); border: 1px solid var(--grid-border); border-radius: 8px; display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; }
        .sidebar-header { padding: 8px 10px; font-size: 0.85rem; font-weight: 800; background: var(--header-bg); border-bottom: 1px solid var(--grid-border); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { overflow-y: auto; flex-grow: 1; min-height: 0; }
        
        /* Roster Styling */
        .employee-item { display: flex; flex-direction: column; padding: 10px; border-bottom: 1px solid #f1f5f9; background: white; transition: background 0.2s; position: relative; }
        .employee-item.trainee-row { background-color: var(--trainee-bg-light); border-left: 4px solid var(--trainee-color); }
        .item-main-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
        .employee-info { font-size: 0.75rem; flex-grow: 1; }
        .status-checks { display: flex; flex-direction: column; gap: 4px; align-items: flex-end; min-width: 65px; }
        .status-label { font-size: 0.55rem; color: #6b7280; font-weight: 700; display: flex; align-items: center; cursor: pointer; gap: 3px; text-transform: uppercase; }
        .trainee-pairing-row { margin-top: 8px; padding-top: 6px; border-top: 1px dashed #ddd; display: flex; align-items: center; gap: 6px; font-size: 0.65rem; color: #4b5563; font-weight: 600; }
        .trainee-dropdown { font-size: 0.65rem; padding: 2px; flex-grow: 1; border-radius: 4px; border: 1px solid #cbd5e1; }

        /* REDESIGNED REQUEST LIST */
        .request-inbox { display: flex; flex-direction: column; height: 210px; min-height: 210px; border-top: 2px solid #2563eb; background: #f8fafc; }
        .request-item { display: flex; flex-direction: column; padding: 10px; border-bottom: 1px solid #e2e8f0; background: #fff; margin: 4px; border-radius: 6px; border-left: 3px solid transparent; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .request-item.active-preview { border-color: var(--commit-blue); background: #f0f9ff; border-left: 3px solid var(--commit-blue); }
        
        .request-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .request-name { font-weight: 800; font-size: 0.85rem; color: #0f172a; }
        .status-pill { font-size: 0.55rem; font-weight: 800; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        .status-pill.pending { background: #ffedd5; color: #9a3412; }
        
        .request-body { background: #f1f5f9; border-radius: 4px; padding: 6px; margin-bottom: 8px; display: flex; flex-direction: column; gap: 2px; }
        .time-row { font-size: 0.65rem; display: flex; justify-content: space-between; align-items: center; }
        .time-label { color: #64748b; font-weight: 600; }
        .time-val { font-weight: 700; color: #1e293b; }
        .time-arrow { color: #2563eb; font-weight: 900; margin: 0 4px; }

        .request-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 4px; }
        .req-btn-group { display: flex; gap: 4px; }
        
        .delete-btn-mini { color: #94a3b8; cursor: pointer; font-size: 1rem; transition: color 0.2s; }
        .delete-btn-mini:hover { color: #ef4444; }

        .pending-badge { background: #2563eb; color: white; font-size: 0.6rem; padding: 1px 5px; border-radius: 10px; font-weight: 900; }
        .badge-trainee { font-size: 0.5rem; background: var(--trainee-text); color: white; padding: 1px 3px; border-radius: 4px; vertical-align: middle; margin-left: 3px; font-weight: 800; }
        .sidebar-detail-tag { font-size: 0.6rem; font-weight: 600; padding: 1px 4px; border-radius: 3px; margin-right: 3px; border: 1px solid #d1d5db; }
        .mini-delete { cursor: pointer; margin-left: 6px; font-weight: 900; font-size: 0.8rem; color: #ef4444; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 450px; }
        .modal-tiny { width: 300px !important; padding: 15px !important; }
        textarea { width: 100%; height: 300px; margin: 10px 0; padding: 10px; font-size: 0.85rem; border: 1px solid var(--grid-border); border-radius: 6px; }
    </style>
</head>
<body>

<div class="app-wrapper">
    <div class="controls">
        <div class="controls-left">
            <input type="date" id="date-picker">
            <button class="btn-undo" id="undo-btn" onclick="undo()">↶</button>
            <button class="btn-redo" id="redo-btn" onclick="redo()">↷</button>
        </div>
        <h2 style="margin:0; flex-grow: 1; text-align: center; font-size: 1.1rem; font-weight: 900; color: #1e293b;">SHIFT GRAPH</h2>
        <div class="controls-right">
            <button onclick="openModal('traineeModal')">Trainees</button>
            <button class="btn-manual" onclick="openModal('manualModal')">Manual</button>
            <button onclick="openModal('rosterModal')">Add Schedule</button>
            <button onclick="openModal('requestModal')">Add Requests</button>
            <button class="btn-clear" onclick="clearAllShifts()">Clear All</button>
        </div>
    </div>

    <div class="main-layout">
        <div class="graph-container">
            <div class="grid-header">
                <div class="time-labels" id="time-labels"></div>
                <div class="coverage-counts" id="coverage-counts"></div>
            </div>
            <div class="grid-scroll-area"><div class="schedule-grid" id="schedule-grid"><div id="now-line"></div><div id="schedule-body"></div></div></div>
        </div>
        <div class="sidebar">
            <div class="sidebar-header">DAILY ROSTER</div>
            <div class="sidebar-content" id="roster-list"></div>
            <div class="request-inbox">
                <div class="sidebar-header" style="background: #2563eb; color: white;">
                    PENDING <span class="pending-badge" id="pending-count">0</span>
                </div>
                <div class="sidebar-content" id="request-inbox-list"></div>
            </div>
        </div>
    </div>
</div>

<div id="traineeModal" class="modal"><div class="modal-content"><h3>Trainee List</h3><textarea id="traineeInput"></textarea><div style="display:flex; justify-content:flex-end; gap:8px;"><button style="background:#6b7280" onclick="closeModal('traineeModal')">Cancel</button><button onclick="saveTrainees()">Apply</button></div></div></div>
<div id="manualModal" class="modal"><div class="modal-content modal-tiny" onkeydown="if(event.key==='Enter') addManualShift()"><h3>Manual Entry</h3><input type="text" id="manualIni" placeholder="Initials" style="margin-bottom:8px; width:100%"><input type="text" id="manualTime" placeholder="hhmm" style="margin-bottom:8px; width:100%"><input type="number" id="manualDur" value="8" style="width:100%"><div style="display:flex; justify-content:flex-end; gap:8px; margin-top:15px;"><button style="background:#6b7280" onclick="closeModal('manualModal')">Cancel</button><button onclick="addManualShift()">Add</button></div></div></div>
<div id="rosterModal" class="modal"><div class="modal-content"><h3>Add Schedule</h3><textarea id="rosterInput"></textarea><div style="display:flex; justify-content:flex-end; gap:8px;"><button style="background:#6b7280" onclick="closeModal('rosterModal')">Cancel</button><button onclick="processRoster()">Apply</button></div></div></div>
<div id="requestModal" class="modal"><div class="modal-content"><h3>Add Requests</h3><textarea id="requestInput"></textarea><div style="display:flex; justify-content:flex-end; gap:8px;"><button style="background:#6b7280" onclick="closeModal('requestModal')">Cancel</button><button onclick="processRequestTable()">Apply</button></div></div></div>

<div id="editModal" class="modal"><div class="modal-content modal-tiny" onkeydown="if(event.key==='Enter') updateShift()"><h3>Edit Shift</h3><span id="currentShiftRef"></span>
    <input type="text" id="editIni" placeholder="Ini" style="margin-bottom:8px; width:100%;">
    <input type="text" id="editTime" placeholder="hhmm" style="margin-bottom:8px; width:100%;">
    <input type="number" id="editDur" placeholder="Hours" style="margin-bottom:8px; width:100%;">
    <input type="text" id="editLeave" placeholder="Leave hhmm-hhmm" style="margin-bottom:8px; width:100%;">
    <input type="text" id="editXte" placeholder="XTE hhmm-hhmm" style="margin-bottom:8px; width:100%;">
    <div style="display:flex; justify-content:flex-end; gap:8px;"><button style="background:#6b7280" onclick="closeModal('editModal')">Cancel</button><button onclick="updateShift()">Update</button></div>
</div></div>

<script>
    const STORAGE_KEY = 'rosterData_vFINAL_SCALED';
    const TRAINEE_KEY = 'roster_trainees';
    let appData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    let traineeList = JSON.parse(localStorage.getItem(TRAINEE_KEY)) || [];
    let undoStack = [], previewIdx = null, activeIdx = null;

    function initHeader() {
        const timeLabels = document.getElementById('time-labels'), coverageCounts = document.getElementById('coverage-counts');
        timeLabels.innerHTML = ""; coverageCounts.innerHTML = "";
        for (let i = 0; i < 24; i++) {
            const hr = (i + 4) % 24;
            const ts = document.createElement('span'); ts.innerText = `${hr.toString().padStart(2, '0')}:00`;
            timeLabels.appendChild(ts);
            const cs = document.createElement('span'); cs.id = `hour-count-${i}`; cs.innerText = '0';
            coverageCounts.appendChild(cs);
        }
    }

    function saveState() { undoStack.push(JSON.stringify(appData)); if (undoStack.length > 50) undoStack.shift(); }
    function undo() { if (undoStack.length) { appData = JSON.parse(undoStack.pop()); saveToStorage(); } }
    function saveToStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); render(document.getElementById('date-picker').value); }
    function getMinutesFrom0400(hh, mm) { let t = (hh * 60) + mm - 240; return t < 0 ? t + 1440 : t; }
    function formatTime(hh, mm) { return `${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}`; }
    function togglePreview(idx) { previewIdx = (previewIdx === idx) ? null : idx; render(document.getElementById('date-picker').value); }
    function toggleInactive(date, idx) { saveState(); appData[date][idx].inactive = !appData[date][idx].inactive; saveToStorage(); }
    function toggleStaffing(date, idx) { saveState(); appData[date][idx].isStaffing = !appData[date][idx].isStaffing; saveToStorage(); }
    function setTrainer(date, tIdx, trainer) { saveState(); appData[date][tIdx].trainer = trainer || null; saveToStorage(); }
    function saveTrainees() { traineeList = document.getElementById('traineeInput').value.split('\n').map(s => s.trim().toUpperCase()).filter(s => s !== ""); localStorage.setItem(TRAINEE_KEY, JSON.stringify(traineeList)); render(document.getElementById('date-picker').value); closeModal('traineeModal'); }

    function updateShift() {
        const date = document.getElementById('date-picker').value, item = appData[date][activeIdx];
        const ini = document.getElementById('editIni').value.trim().toUpperCase(), tm = document.getElementById('editTime').value.trim().match(/^(\d{2})(\d{2})$/), d = parseInt(document.getElementById('editDur').value);
        if(!ini || !tm) return;
        saveState(); item.name = ini; item.durHours = d; item.duration = d * 60;
        item.start = getMinutesFrom0400(parseInt(tm[1]), parseInt(tm[2]));
        item.label = `${formatTime(parseInt(tm[1]), parseInt(tm[2]))} - ${formatTime((parseInt(tm[1])+d)%24, parseInt(tm[2]))}`;
        const lvRaw = document.getElementById('editLeave').value.trim(), lvMatch = lvRaw.match(/^(\d{2})(\d{2})-(\d{2})(\d{2})$/);
        if (lvMatch) item.leave = { start: getMinutesFrom0400(parseInt(lvMatch[1]), parseInt(lvMatch[2])), end: getMinutesFrom0400(parseInt(lvMatch[3]), parseInt(lvMatch[4])), label: lvRaw };
        else if (lvRaw === "") delete item.leave;
        const xteRaw = document.getElementById('editXte').value.trim(), xteMatch = xteRaw.match(/^(\d{2})(\d{2})-(\d{2})(\d{2})$/);
        if (xteMatch) item.xte = { start: getMinutesFrom0400(parseInt(xteMatch[1]), parseInt(xteMatch[2])), end: getMinutesFrom0400(parseInt(xteMatch[3]), parseInt(xteMatch[4])), label: xteRaw };
        else if (xteRaw === "") delete item.xte;
        saveToStorage(); closeModal('editModal');
    }

    function processRoster() {
        const raw = document.getElementById('rosterInput').value, date = document.getElementById('date-picker').value;
        if (!date || !raw) return;
        saveState(); if (appData[date]) appData[date] = appData[date].filter(item => item.status !== "Approved!"); else appData[date] = [];
        let curH = 0, curM = 0, curD = 8;
        raw.split('\n').forEach(line => {
            const tmM = line.match(/^(\d{2})(\d{2})(?:-(\d+))?/);
            if (tmM) { curH = parseInt(tmM[1]); curM = parseInt(tmM[2]); curD = tmM[3] ? parseInt(tmM[3]) : 8; }
            else if (/[A-Z]{2,}/.test(line)) {
                line.split(/\s+/).forEach(n => { if (n.length >= 2) {
                    const ini = n.length === 4 ? n.substring(2) : n;
                    appData[date].push({ name: ini, start: getMinutesFrom0400(curH, curM), duration: curD * 60, durHours: curD, label: `${formatTime(curH, curM)} - ${formatTime((curH+curD)%24, curM)}`, status: 'Approved!' });
                }});
            }
        });
        document.getElementById('rosterInput').value = ''; saveToStorage(); closeModal('rosterModal');
    }

    function processRequestTable() {
        const raw = document.getElementById('requestInput').value, date = document.getElementById('date-picker').value;
        if (!date || !raw) return;
        saveState(); if (!appData[date]) appData[date] = [];
        const rosteredNames = appData[date].filter(s => s.status === "Approved!").map(s => s.name);
        const exceptions = ["x", "a", "sl", "hl", "xtu"];
        raw.split('\n').forEach(line => {
            const tokens = line.trim().split(/\t|\s{2,}/);
            if (tokens.length >= 6) {
                const statusStr = tokens[5], isApproved = statusStr === "Approved!", isDenied = statusStr === "Denied", isPending = statusStr.toLowerCase().includes("pending") || (!isApproved && !isDenied && tokens.length > 6);
                if (isApproved || isDenied || isPending) {
                    let initials = tokens[0].length === 4 ? tokens[0].substring(2) : tokens[0];
                    if (!rosteredNames.includes(initials) && !exceptions.some(ex => tokens[2].toLowerCase().includes(ex))) return;
                    let toMatch = tokens[3].match(/(\d{2})(\d{2})(?:-(\d+))?/);
                    let isRDO = tokens[3].toLowerCase() === "x";
                    if (initials && (toMatch || isRDO)) {
                        let hh = toMatch ? parseInt(toMatch[1]) : 0, mm = toMatch ? parseInt(toMatch[2]) : 0, dur = toMatch ? (toMatch[3] ? parseInt(toMatch[3]) : 8) : 8;
                        let label = isRDO ? "RDO (Day Off)" : `${formatTime(hh, mm)} - ${formatTime((hh + dur) % 24, mm)}`;
                        if (isApproved) { appData[date] = appData[date].filter(s => !(s.name === initials && s.status === "Approved!")); appData[date].push({ name: initials, start: getMinutesFrom0400(hh, mm), duration: dur * 60, durHours: dur, label: label, status: "Approved!", isRDO: isRDO }); }
                        else if (!appData[date].some(e => e.name === initials && e.label === label && e.status === (isDenied ? "Denied" : "Pending"))) {
                            appData[date].push({ name: initials, start: getMinutesFrom0400(hh, mm), duration: dur * 60, durHours: dur, label: label, status: (isDenied ? "Denied" : "Pending"), from: tokens[2], shortTo: isRDO ? "X" : tokens[3], isRDO: isRDO });
                        }
                    }
                }
            }
        });
        document.getElementById('requestInput').value = ''; saveToStorage(); closeModal('requestModal');
    }

    function removeSegment(e, date, idx, type) { e.stopPropagation(); saveState(); if (type === 'leave') delete appData[date][idx].leave; if (type === 'xte') delete appData[date][idx].xte; saveToStorage(); }
    function deleteItem(d, i) { saveState(); appData[d].splice(i, 1); if(previewIdx === i) previewIdx = null; saveToStorage(); }
    function commitRequest(idx) { saveState(); const date = document.getElementById('date-picker').value, req = appData[date][idx]; appData[date] = appData[date].filter(s => !(s.name === req.name && s.status === "Approved!")); req.status = "Approved!"; if (previewIdx === idx) previewIdx = null; saveToStorage(); }
    function addManualShift() { const date = document.getElementById('date-picker').value, ini = document.getElementById('manualIni').value.trim().toUpperCase(), tm = document.getElementById('manualTime').value.trim().match(/^(\d{2})(\d{2})$/), d = parseInt(document.getElementById('manualDur').value) || 8; if(!date || !ini || !tm) return; saveState(); if (!appData[date]) appData[date] = []; appData[date].push({ name: ini, start: getMinutesFrom0400(parseInt(tm[1]), parseInt(tm[2])), duration: d * 60, durHours: d, label: `${formatTime(parseInt(tm[1]), parseInt(tm[2]))} - ${formatTime((parseInt(tm[1])+d)%24, parseInt(tm[2]))}`, status: 'Approved!' }); saveToStorage(); closeModal('manualModal'); }
    function clearAllShifts() { if(confirm("Clear data?")) { saveState(); appData[document.getElementById('date-picker').value]=[]; saveToStorage(); } }

    function openModal(id, idx = null) {
        document.getElementById(id).style.display = 'flex'; activeIdx = idx; const date = document.getElementById('date-picker').value;
        if (idx !== null) {
            const item = appData[date][idx];
            if (id === 'editModal') {
                document.getElementById('editIni').value = item.name; document.getElementById('editTime').value = item.label.match(/^(\d{2}):(\d{2})/) ? item.label.match(/^(\d{2}):(\d{2})/)[1] + item.label.match(/^(\d{2}):(\d{2})/)[2] : "";
                document.getElementById('editDur').value = item.durHours; document.getElementById('editLeave').value = item.leave ? item.leave.label : ""; document.getElementById('editXte').value = item.xte ? item.xte.label : "";
            }
        }
        if (id === 'traineeModal') document.getElementById('traineeInput').value = traineeList.join('\n');
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function render(date) {
        const rosterBox = document.getElementById('roster-list'), inboxList = document.getElementById('request-inbox-list'), gridBody = document.getElementById('schedule-body');
        rosterBox.innerHTML = ""; inboxList.innerHTML = ""; gridBody.innerHTML = ""; const counts = Array(24).fill(0);
        let itemsWithIds = (appData[date] || []).map((s, idx) => ({ ...s, originalIdx: idx }));
        let approved = itemsWithIds.filter(s => s.status === "Approved!" && !s.isRDO);
        document.getElementById('pending-count').innerText = itemsWithIds.filter(s => s.status !== "Approved!").length;

        let staff = approved.filter(s => !traineeList.includes(s.name)).sort((a,b) => a.start - b.start);
        let trainees = approved.filter(s => traineeList.includes(s.name)).sort((a,b) => a.start - b.start);
        let previewItem = previewIdx !== null ? itemsWithIds[previewIdx] : null;
        let sortedVisualItems = [];
        staff.forEach(member => {
            sortedVisualItems.push({ item: member, state: (previewItem && previewItem.name === member.name) ? 'replaced' : 'normal' });
            trainees.filter(t => t.trainer === member.name).forEach(t => sortedVisualItems.push({ item: t, state: (previewItem && previewItem.name === t.name) ? 'replaced' : 'normal' }));
        });
        trainees.filter(t => !t.trainer).forEach(t => {
            let pos = sortedVisualItems.findIndex(s => s.item.start > t.start);
            if(pos === -1) sortedVisualItems.push({ item: t, state: (previewItem && previewItem.name === t.name) ? 'replaced' : 'normal' });
            else sortedVisualItems.splice(pos, 0, { item: t, state: (previewItem && previewItem.name === t.name) ? 'replaced' : 'normal' });
        });

        if (previewItem && previewItem.status !== "Approved!") {
            const isT = traineeList.includes(previewItem.name), pTrainer = previewItem.trainer;
            if (isT && pTrainer) { let trIdx = sortedVisualItems.findIndex(s => s.item.name === pTrainer); if (trIdx !== -1) sortedVisualItems.splice(trIdx + 1, 0, { item: previewItem, state: 'new' }); else sortedVisualItems.push({ item: previewItem, state: 'new' }); }
            else { let pos = sortedVisualItems.findIndex(s => s.item.start > previewItem.start); if (pos === -1) sortedVisualItems.push({ item: previewItem, state: 'new' }); else sortedVisualItems.splice(pos, 0, { item: previewItem, state: 'new' }); }
        }

        itemsWithIds.sort((a,b) => a.start - b.start).forEach((s) => {
            if (s.status === "Approved!") {
                if (s.isRDO) return; const item = document.createElement('div'); const isT = traineeList.includes(s.name);
                item.className = 'employee-item' + (s.inactive ? ' inactive' : '') + (isT ? ' trainee-row' : '');
                let tags = ""; if (s.leave) tags += `<span class="sidebar-detail-tag">LV: ${s.leave.label}<span class="mini-delete" onclick="removeSegment(event, '${date}', ${s.originalIdx}, 'leave')">×</span></span>`;
                if (s.xte) tags += `<span class="sidebar-detail-tag" style="background:#ecfdf5">XTE: ${s.xte.label}<span class="mini-delete" onclick="removeSegment(event, '${date}', ${s.originalIdx}, 'xte')">×</span></span>`;
                let drop = isT ? `<div class="trainee-pairing-row">w/ <select class="trainee-dropdown" onchange="setTrainer('${date}', ${s.originalIdx}, this.value)"><option value="">-Trainer-</option>${staff.map(t => `<option value="${t.name}" ${s.trainer===t.name?'selected':''}>${t.name}</option>`).join('')}</select></div>` : "";
                item.innerHTML = `<div class="item-main-row"><div class="employee-info"><b>${s.name}${isT?'<span class="badge-trainee">T</span>':''}</b><br><small>${s.label}</small><br>${tags}<br><button class="btn-action btn-edit" onclick="openModal('editModal', ${s.originalIdx})">Edit</button></div><div class="status-checks"><label class="status-label"><input type="checkbox" ${s.inactive?'checked':''} onchange="toggleInactive('${date}', ${s.originalIdx})">Inactive</label>${isT ? `<label class="status-label"><input type="checkbox" ${s.isStaffing?'checked':''} onchange="toggleStaffing('${date}', ${s.originalIdx})">Staffing</label>` : ''}<div class="delete-btn" onclick="deleteItem('${date}', ${s.originalIdx})">×</div></div></div>${drop}`;
                rosterBox.appendChild(item);
            } else {
                const item = document.createElement('div'), isPrev = previewIdx === s.originalIdx;
                item.className = 'request-item' + (isPrev ? ' active-preview' : '');
                item.innerHTML = `
                    <div class="request-header"><span class="request-name">${s.name}</span><span class="status-pill pending">PENDING</span></div>
                    <div class="request-body">
                        <div class="time-row"><span class="time-label">CURRENT</span><span class="time-val">${s.from}</span></div>
                        <div class="time-row"><span class="time-label">REQUEST</span><span class="time-val">${s.shortTo}</span></div>
                    </div>
                    <div class="request-footer">
                        <div class="req-btn-group">
                            <button class="btn-action" style="background:${isPrev?'#ef4444':'#4b5563'}" onclick="togglePreview(${s.originalIdx})">${isPrev ? 'Stop' : 'Preview'}</button>
                            <button class="btn-action" style="background:#0ea5e9" onclick="commitRequest(${s.originalIdx})">Commit</button>
                        </div>
                        <div class="delete-btn-mini" onclick="deleteItem('${date}', ${s.originalIdx})">×</div>
                    </div>`;
                inboxList.appendChild(item);
            }
        });

        sortedVisualItems.forEach(obj => {
            const paired = trainees.find(t => t.trainer === obj.item.name && !t.isStaffing);
            let tWin = (paired && !traineeList.includes(obj.item.name)) ? { start: paired.start, end: (paired.start + paired.duration) } : null;
            renderBar(obj.item, gridBody, counts, obj.state, traineeList.includes(obj.item.name), tWin, obj.item.isStaffing);
        });

        for(let i=0; i<24; i++) {
            const box = document.getElementById(`hour-count-${i}`), h = (i + 4) % 24, val = counts[i];
            box.innerText = val; box.className = ""; 
            if (h >= 8 && h <= 20) { if (val <= 5) box.classList.add('count-danger'); else if (val === 6) box.classList.add('count-warning'); }
        }
        updateNowLine();
    }

    function renderBar(s, container, counts, state, isT, tWin, isStaffing) {
        let bS = s.start, bE = s.start + s.duration; if (s.xte) { bS = Math.min(bS, s.xte.start); bE = Math.max(bE, s.xte.end); }
        const track = document.createElement('div'), bar = document.createElement('div');
        track.className = 'shift-track'; bar.className = 'shift-bar';
        if (isT && !isStaffing) bar.classList.add('bar-trainee'); if (s.inactive) bar.classList.add('bar-inactive');
        if (state === 'new') bar.classList.add('preview-new'); if (state === 'replaced') bar.classList.add('preview-replaced');

        if (tWin && state === 'normal' && !s.inactive) {
            const stripe = document.createElement('div'); stripe.className = 'overlay-segment trainer-stripes-overlay';
            if (tWin.end > tWin.start) { stripe.style.left = ((tWin.start - bS) / (bE - bS) * 100) + "%"; stripe.style.width = ((Math.min(tWin.end, s.start + s.duration - 60) - tWin.start) / (bE - bS) * 100) + "%"; bar.appendChild(stripe); }
        }
        const endH = (Math.floor((s.start + s.duration) / 60) + 4) % 24;
        if (state === 'normal' && !s.inactive && (!isT || isStaffing) && endH <= 22 && endH >= 5 && s.start < 1020) {
            const yellow = document.createElement('div'); yellow.className = 'overlay-segment yellow-bar-overlay';
            const wE = (s.leave && s.leave.end === (s.start+s.duration)) ? s.leave.start : (s.start+s.duration);
            yellow.style.left = ((wE - 60 - bS) / (bE - bS) * 100) + "%"; yellow.style.width = (60 / (bE - bS) * 100) + "%"; bar.appendChild(yellow);
        }
        if (state === 'normal' && s.xte) { const x = document.createElement('div'); x.className = 'overlay-segment xte-segment'; x.style.left = ((s.xte.start - bS) / (bE - bS) * 100) + "%"; x.style.width = ((s.xte.end - s.xte.start) / (bE - bS) * 100) + "%"; x.innerHTML = `<span>XTE</span>`; bar.appendChild(x); }
        if (state === 'normal' && s.leave) { const l = document.createElement('div'); l.className = 'overlay-segment leave-segment'; l.style.left = ((s.leave.start - bS) / (bE - bS) * 100) + "%"; l.style.width = ((s.leave.end - s.leave.start) / (bE - bS) * 100) + "%"; l.innerHTML = `<span>LV</span>`; bar.appendChild(l); }

        bar.style.gridColumn = `${bS + 1} / span ${bE - bS}`;
        bar.innerHTML += `<span class="bar-content-text"><b>${s.name}</b> <span>${s.label}</span></span>`;
        track.appendChild(bar); container.appendChild(track);

        if (state === 'normal' && !s.inactive && (!isT || isStaffing)) {
            for (let i = 0; i < 24; i++) {
                const hourMin = i * 60, hourMax = hourMin + 60, slotH = (i + 4) % 24;
                let wS = Math.max(s.start, hourMin), wE = Math.min(s.start + s.duration, hourMax), mins = Math.max(0, wE - wS);
                if (s.leave) mins -= Math.max(0, Math.min(s.leave.end, hourMax) - Math.max(s.leave.start, hourMin));
                if (mins > 0) { if ((wE === (s.start + s.duration)) && (slotH <= 22 && slotH >= 5) && s.start < 1020) { if (mins >= 60) counts[i]++; } else { if (mins >= 30) counts[i]++; } }
            }
        }
    }

    document.getElementById('date-picker').value = new Date().toISOString().split('T')[0];
    document.getElementById('date-picker').addEventListener('change', () => { saveToStorage(); });
    initHeader(); render(document.getElementById('date-picker').value);
    function updateNowLine() {
        const now = new Date(), pickerDate = document.getElementById('date-picker').value; if (!pickerDate) return;
        const [y, m, d] = pickerDate.split('-').map(Number), vS = new Date(y, m - 1, d, 4, 0, 0), vE = new Date(vS.getTime() + 24 * 60 * 60 * 1000);
        const line = document.getElementById('now-line');
        if (now >= vS && now < vE) { line.style.left = ((now - vS) / (1000 * 60) / 1440 * 100) + "%"; line.style.display = 'block'; } else line.style.display = 'none';
    }
    setInterval(updateNowLine, 30000);
</script>
</body>
</html>
