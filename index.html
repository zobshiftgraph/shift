<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Graph - v79 Dual Bar Fix</title>
    <style>
        :root {
            --row-height: 32px; --bar-height: 24px; --grid-border: #d1d5db;
            --line-color: #e5e7eb; --bar-color: #93c5fd; --bar-text: #1e3a8a;  
            --trainee-color: #d8b4fe; --trainee-text: #581c87; --trainee-bg-light: #f5f3ff;
            --handover-yellow: #fef08a; --sidebar-bg: #ffffff; --header-bg: #f3f4f6;
            --cic-green: #10b981; --success-bg: #dcfce7; --success-text: #166534;
            --danger-bg: #fee2e2; --danger-text: #991b1b; --warning-bg: #fef9c3;
            --warning-text: #854d0e;
        }

        body, html { height: 100%; margin: 0; font-family: 'Inter', system-ui, sans-serif; background-color: #f9fafb; overflow: hidden; }
        .app-wrapper { display: flex; flex-direction: column; height: 100vh; padding: 6px; box-sizing: border-box; position: relative; }
        
        .controls { display: flex; justify-content: space-between; align-items: center; padding-bottom: 6px; flex-shrink: 0; gap: 10px; z-index: 1000; position: relative; }
        .controls-left, .controls-right { display: flex; align-items: center; gap: 6px; }
        
        input[type="date"], input[type="text"], input[type="number"], select { padding: 6px; border: 1px solid var(--grid-border); border-radius: 6px; font-size: 0.85rem; }
        button { padding: 6px 12px; background-color: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
        .btn-undo, .btn-redo { background-color: #64748b; font-size: 1.1rem; padding: 4px 12px; }
        .btn-clear { background-color: #ef4444; }

        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; left: 0; top: 100%; margin-top: 4px; background-color: white; min-width: 160px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid var(--grid-border); border-radius: 6px; z-index: 2000; }
        .dropdown-content button { width: 100%; text-align: left; background: none; color: #374151; padding: 10px 12px; border-radius: 0; border-bottom: 1px solid #f3f4f6; cursor: pointer; border: none; }
        .show { display: block; }

        .main-layout { display: flex; flex-grow: 1; gap: 8px; overflow: hidden; min-height: 0; }
        .graph-container { flex-grow: 1; background: white; border: 1px solid var(--grid-border); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; position: relative; min-width: 0; }
        .grid-scroll-area { flex-grow: 1; overflow-y: auto; overflow-x: auto; position: relative; min-height: 0; }
        .schedule-grid { display: flex; flex-direction: column; min-height: 100%; width: 1440px; position: relative; background-image: linear-gradient(to right, var(--line-color) 1px, transparent 1px); background-size: 60px 100%; }

        .sticky-grid-header { position: sticky; top: 0; z-index: 100; background: white; border-bottom: 1px solid var(--grid-border); width: 1440px; }
        .time-labels { display: grid; grid-template-columns: repeat(24, 1fr); width: 1440px; height: 28px; background: var(--header-bg); align-items: center; transform: translateX(-30px); }
        .time-labels span { font-size: 0.8rem; font-weight: 700; color: #374151; text-align: center; }
        .coverage-counts { display: grid; grid-template-columns: repeat(24, 1fr); width: 1440px; height: 24px; background: #eff6ff; align-items: center; }
        .coverage-counts span { font-size: 0.75rem; font-weight: 900; color: var(--bar-text); text-align: center; height: 100%; display: flex; align-items: center; justify-content: center; border-right: 1px solid rgba(209, 213, 219, 0.3); }

        /* PREVIEW STYLING */
        .preview-glow { 
            border: 3px solid #22c55e !important; 
            box-shadow: 0 0 15px #22c55e, inset 0 0 10px #22c55e !important; 
            z-index: 300 !important;
            animation: pulse-glow 1.2s infinite;
        }
        .preview-greyout { 
            background-color: #cbd5e1 !important; 
            color: #94a3b8 !important; 
            opacity: 0.4 !important; 
            border: 1px dashed #94a3b8 !important; 
            box-shadow: none !important;
        }
        @keyframes pulse-glow { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }

        .shift-track { display: grid; grid-template-columns: repeat(1440, 1fr); height: var(--row-height); align-items: center; border-bottom: 1px solid #f3f4f6; position: relative; z-index: 5; }
        .shift-bar { background-color: var(--bar-color); color: var(--bar-text); height: var(--bar-height); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.1); overflow: hidden; white-space: nowrap; font-weight: bold; position: relative; min-width: 0; }
        .bar-text-wrapper { position: absolute; top: 0; height: 100%; display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 20; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 4px; box-sizing: border-box; }
        
        .bar-trainee { background-color: var(--trainee-color) !important; color: var(--trainee-text) !important; }
        .bar-inactive { background-color: #e5e7eb !important; opacity: 0.6; }

        .overlay-segment { position: absolute; top: 0; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.1; overflow: hidden; box-sizing: border-box; border: 1px solid rgba(255,255,255,0.15); }
        .trainer-stripes-overlay { background-image: repeating-linear-gradient(45deg, rgba(107, 33, 168, 0.2), rgba(107, 33, 168, 0.2) 10px, transparent 10px, transparent 20px); z-index: 11; border: none; }
        .yellow-bar-overlay { background-color: var(--handover-yellow); z-index: 11; border: none; }
        .xte-segment { background-color: #10b981; color: white; z-index: 12; }
        .leave-segment { background-color: #6b7280; color: white; z-index: 13; }
        .segment-label { font-size: 0.55rem; font-weight: 900; }

        .sidebar { width: 320px; background: var(--sidebar-bg); border: 1px solid var(--grid-border); border-radius: 8px; display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; }
        .sidebar-header { padding: 10px; font-size: 0.85rem; font-weight: 800; background: var(--header-bg); border-bottom: 1px solid var(--grid-border); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { overflow-y: auto; flex-grow: 1; min-height: 0; }
        
        .employee-item { display: flex; flex-direction: column; padding: 10px 12px; border-bottom: 1px solid #cbd5e1; background: white; min-height: 64px; justify-content: center; box-sizing: border-box; position: relative; }
        .employee-item.trainee-row { background-color: var(--trainee-bg-light); border-left: 4px solid var(--trainee-color); }
        .delete-btn { position: absolute; top: 2px; right: 6px; color: #ef4444; cursor: pointer; font-weight: 900; font-size: 1.2rem; padding: 4px; z-index: 20; }
        .chk-group { display: flex; gap: 8px; align-items: center; margin-top: 4px; }
        .chk-container { display: flex; align-items: center; gap: 4px; font-size: 0.65rem; cursor: pointer; color: #475569; font-weight: 600; }
        input[type="checkbox"] { margin: 0; width: 13px; height: 13px; cursor: pointer; }

        .request-inbox { display: none; flex-direction: column; height: 420px; border-top: 3px solid #2563eb; background: #f8fafc; }
        .request-item { display: flex; flex-direction: column; padding: 10px; border-bottom: 1px solid #cbd5e1; background: #fff; margin: 6px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .req-info { font-weight: 800; color: #1e293b; line-height: 1.3; font-size: 0.8rem; margin-bottom: 4px; }
        .req-status-tag { font-size: 0.65rem; padding: 1px 6px; border-radius: 3px; font-weight: 700; display: inline-block; }
        .tag-pending { background: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        .tag-denied { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        
        .req-buttons { display: flex; gap: 6px; margin-top: 6px; }
        .btn-preview.active { background: #1e1b4b; border: 1px solid #22c55e; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000; padding: 20px; box-sizing: border-box; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 600px; display: flex; flex-direction: column; max-height: 90vh; box-sizing: border-box; overflow: hidden; }
        textarea { flex-grow: 1; width: 100%; min-height: 200px; padding: 12px; font-family: 'Courier New', monospace; font-size: 0.85rem; border: 1px solid var(--grid-border); border-radius: 8px; resize: vertical; box-sizing: border-box; }
        #now-line { position: absolute; top: 0; bottom: 0; width: 2px; background-color: #ef4444; z-index: 110; pointer-events: none; display: none; }
    </style>
</head>
<body>

<div class="app-wrapper">
    <div class="controls">
        <div class="controls-left">
            <div class="dropdown">
                <button class="btn-menu" onclick="toggleMenu()">☰ Menu</button>
                <div id="mainDropdown" class="dropdown-content">
                    <button onclick="openModal('trainerListModal')">Trainers List</button>
                    <button onclick="openModal('traineeModal')">Trainees List</button>
                    <button onclick="openModal('manualModal')">Manual Entry</button>
                </div>
            </div>
            <input type="date" id="date-picker">
            <button class="btn-undo" id="undoBtn" onclick="undo()">↶</button>
            <button class="btn-redo" id="redoBtn" onclick="redo()">↷</button>
        </div>
        <h2 style="margin:0; flex-grow: 1; text-align: center; font-size: 1.1rem; font-weight: 900; color: #1e293b;">SHIFT GRAPH</h2>
        <div class="controls-right">
            <button onclick="openModal('rosterModal')">Add Schedule</button>
            <button onclick="openModal('requestModal')">Add Requests</button>
            <button class="btn-clear" onclick="clearAllShifts()">Clear All</button>
        </div>
    </div>

    <div class="main-layout">
        <div class="graph-container">
            <div class="grid-scroll-area" id="graph-scroll-container">
                <div class="schedule-grid" id="schedule-grid">
                    <div class="sticky-grid-header">
                        <div class="time-labels" id="time-labels-inner"></div>
                        <div class="coverage-counts" id="coverage-counts-inner"></div>
                    </div>
                    <div id="now-line"></div>
                    <div id="schedule-body"></div>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="sidebar-header">DAILY ROSTER</div>
            <div class="sidebar-content" id="roster-list-container"></div>
            
            <div class="request-inbox" id="request-inbox-container">
                <div class="sidebar-header" style="background: #2563eb; color: white; padding: 8px 10px;">
                    REQUESTS <span id="pending-count-badge" style="background:white; color:#2563eb; padding: 0 5px; border-radius: 10px; font-size: 0.7rem;">0</span>
                </div>
                <div class="sidebar-content" id="request-inbox-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = 'rosterData_v79_dual_fix';
    let appData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    let traineeList = JSON.parse(localStorage.getItem('roster_trainees')) || [];
    let trainersList = JSON.parse(localStorage.getItem('roster_trainers_list')) || [];
    let undoStack = [], redoStack = [];
    let activePreviewIdx = null;

    function saveState() { undoStack.push(JSON.stringify(appData)); redoStack = []; updateHistoryButtons(); }
    function undo() { if (undoStack.length) { redoStack.push(JSON.stringify(appData)); appData = JSON.parse(undoStack.pop()); saveToStorage(); } }
    function redo() { if (redoStack.length) { redoStack.push(JSON.stringify(appData)); appData = JSON.parse(redoStack.pop()); saveToStorage(); } }
    function updateHistoryButtons() { 
        if(document.getElementById('undoBtn')) document.getElementById('undoBtn').disabled = (undoStack.length === 0);
        if(document.getElementById('redoBtn')) document.getElementById('redoBtn').disabled = (redoStack.length === 0);
    }
    function saveToStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); render(document.getElementById('date-picker').value); }
    function getMinutesFrom0400(h, m) { let t = (h * 60) + m - 240; return t < 0 ? t + 1440 : t; }
    function formatTime(h, m) { return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`; }

    function toggleMenu() { document.getElementById("mainDropdown").classList.toggle("show"); }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function processRoster() {
        const raw = document.getElementById('rosterInput').value, date = document.getElementById('date-picker').value;
        if (!date || !raw) return closeModal('rosterModal');
        saveState(); if (!appData[date]) appData[date] = [];
        let curH = 0, curM = 0, curD = 8;
        raw.split('\n').forEach(line => {
            const tmM = line.match(/^(\d{2})(\d{2})(?:-(\d+))?/);
            if (tmM) { curH = parseInt(tmM[1]); curM = parseInt(tmM[2]); curD = tmM[3] ? parseInt(tmM[3]) : 8; }
            else if (/[A-Z\[\]]{2,}/.test(line)) {
                line.split(/\s+/).forEach(n => { 
                    let tr = n.trim().replace(/[\[\]\(\)]/g, '').toUpperCase();
                    if(tr.length < 2) return;
                    appData[date].push({ name: tr, start: getMinutesFrom0400(curH, curM), duration: curD * 60, durHours: curD, label: `${formatTime(curH, curM)} - ${formatTime((curH+curD)%24, curM)}`, status: 'Approved!', isCIC: n.includes('('), inactive: false, isStaffing: false });
                });
            }
        });
        closeModal('rosterModal'); saveToStorage();
    }

    function addManualShift() {
        const date = document.getElementById('date-picker').value, ini = document.getElementById('manualIni').value.toUpperCase();
        const tm = document.getElementById('manualTime').value, dur = parseInt(document.getElementById('manualDur').value);
        if(!ini || tm.length < 4) return;
        saveState(); if (!appData[date]) appData[date] = [];
        const h = parseInt(tm.substring(0,2)), m = parseInt(tm.substring(2,4));
        appData[date].push({ name: ini, start: getMinutesFrom0400(h, m), duration: dur * 60, durHours: dur, label: `${formatTime(h, m)} - ${formatTime((h+dur)%24, m)}`, status: 'Approved!', inactive: false, isStaffing: false });
        closeModal('manualModal'); saveToStorage();
    }

    function verifyRequests() {
        const raw = document.getElementById('requestInput').value, debugBody = document.getElementById('debugTableBody');
        let allFound = [];
        const mainRegex = /([A-Z]{2,4})\s*(Annual|A|Sick|SL|SickShift|XTU|Admin|Holiday|HL|XTE|Shift\s?Chg|Shift\s?Change)(.*?)(Approved!|Denied|Pending)/gi;
        const matches = [...raw.matchAll(mainRegex)];
        matches.forEach(match => {
            const ini = match[1].toUpperCase(), type = match[2], middle = match[3], status = match[4];
            let times = middle.match(/(\d{4}(?:-\d{1,2})?)/g) || middle.match(/(\d{2}:\d{2})/g) || [];
            const fromRaw = times[0] || "-", toRaw = times[1] || "-";
            const durMatch = toRaw.match(/-(\d{1,2})/);
            let duration = durMatch ? parseInt(durMatch[1]) : 8;
            let leaveTypes = ["ANNUAL", "A", "SICK", "SL", "SICKSHIFT", "XTU", "ADMIN", "HOLIDAY", "HL"];
            let isLeave = leaveTypes.includes(type.toUpperCase());
            let isXTE = (type.toUpperCase() === "XTE");
            let isShiftChg = type.toLowerCase().includes("shift");
            if (status !== "Approved!" || (isLeave && duration < 8) || isXTE) {
                allFound.push({ name: ini, type, from: fromRaw, to: toRaw, status, calcDur: duration, isLeave, isXTE, isShiftChg });
            }
        });
        window.tempRequestData = allFound; 
        debugBody.innerHTML = "";
        allFound.forEach(req => debugBody.insertAdjacentHTML('beforeend', `<tr><td>${req.name}</td><td>${req.type}</td><td>${req.from}</td><td>${req.to}</td><td>${req.status}</td></tr>`));
        document.getElementById('debugTableContainer').style.display = 'block';
        document.getElementById('verifyReqBtn').style.display = 'none';
        document.getElementById('saveReqBtn').style.display = 'inline-block';
    }

    function applyRequests() {
        const date = document.getElementById('date-picker').value;
        saveState(); if (!appData[date]) appData[date] = [];
        window.tempRequestData.forEach(req => {
            if (req.isXTE && req.status === "Approved!") {
                const shift = appData[date].find(s => s.name === req.name && s.status === "Approved!");
                if (shift) {
                    let f = req.from.replace(/[:\-]/g,'').substring(0,4), t = req.to.replace(/[:\-]/g,'').substring(0,4);
                    shift.xte = { start: getMinutesFrom0400(parseInt(f.substring(0,2)), parseInt(f.substring(2,4))), end: getMinutesFrom0400(parseInt(t.substring(0,2)), parseInt(t.substring(2,4))), label: `${f.substring(0,2)}:${f.substring(2,4)}-${t.substring(0,2)}:${t.substring(2,4)}` };
                }
            } else { appData[date].push({ ...req, initials: req.name, start: 0, duration: 0 }); }
        });
        saveToStorage(); closeModal('requestModal');
    }

    function togglePreview(idx) {
        if (activePreviewIdx === idx) activePreviewIdx = null;
        else activePreviewIdx = idx;
        render(document.getElementById('date-picker').value);
    }

    function commitPending(idx) {
        saveState(); const date = document.getElementById('date-picker').value, req = appData[date][idx];
        const shift = appData[date].find(s => s.name === req.name && s.status === "Approved!");
        if (shift) {
            if (req.isShiftChg) {
                const clean = req.to.replace(/[:\-10]/g,'').substring(0,4);
                const h = parseInt(clean.substring(0,2)), m = parseInt(clean.substring(2,4));
                shift.start = getMinutesFrom0400(h, m); shift.durHours = req.calcDur; shift.duration = req.calcDur * 60;
                shift.label = `${formatTime(h, m)} - ${formatTime((h+req.calcDur)%24, m)}`;
            } else {
                let f = req.from.replace(/[:\-]/g,'').substring(0,4), t = req.to.replace(/[:\-]/g,'').substring(0,4);
                shift.leave = { start: getMinutesFrom0400(parseInt(f.substring(0,2)), parseInt(f.substring(2,4))), end: getMinutesFrom0400(parseInt(t.substring(0,2)), parseInt(t.substring(2,4))), label: `${f.substring(0,2)}:${f.substring(2,4)}-${t.substring(0,2)}:${t.substring(2,4)}` };
            }
        }
        appData[date].splice(idx, 1); activePreviewIdx = null; saveToStorage();
    }

    function render(date) {
        const rosterBox = document.getElementById('roster-list-container'), gridBody = document.getElementById('schedule-body'), inbox = document.getElementById('request-inbox-list');
        rosterBox.innerHTML = ""; gridBody.innerHTML = ""; inbox.innerHTML = "";
        const counts = Array(24).fill(0); 
        let rawItems = (appData[date] || []).map((s, idx) => ({ ...s, originalIdx: idx }));
        let approved = rawItems.filter(s => s.status === "Approved!");
        let pending = rawItems.filter(s => s.status !== "Approved!" || (s.isLeave && s.calcDur < 8));
        document.getElementById('request-inbox-container').style.display = pending.length > 0 ? 'flex' : 'none';
        document.getElementById('pending-count-badge').innerText = pending.length;

        approved.forEach(s => {
            if (!s.inactive && (!traineeList.includes(s.name) || s.isStaffing)) {
                for (let i = 0; i < 24; i++) {
                    const hMin = i * 60, hMax = hMin + 60, realH = (i + 4) % 24;
                    let mins = Math.max(0, Math.min(s.start + s.duration, hMax) - Math.max(s.start, hMin));
                    if (s.leave) mins -= Math.max(0, Math.min(s.leave.end, hMax) - Math.max(s.leave.start, hMin));
                    if (mins > 0 && !((realH >= 5 && realH < 20) && (Math.min(s.start+s.duration, 1440) === hMax))) { if (i >= 16 || mins >= 30) counts[i]++; }
                }
            }
        });

        let sidebarSorted = [...approved].sort((a,b) => a.start - b.start);
        sidebarSorted.forEach((s) => {
            const isT = traineeList.includes(s.name);
            const item = document.createElement('div'); item.className = 'employee-item' + (isT ? ' trainee-row' : '');
            let tags = s.leave ? `<span class="sidebar-detail-tag">LV ${s.leave.label}</span>` : "";
            let trOptions = sidebarSorted.filter(t => trainersList.includes(t.name) && !traineeList.includes(t.name)).map(t => `<option value="${t.name}" ${s.trainer===t.name?'selected':''}>${t.name}</option>`).join('');
            let dd = isT ? `<select style="margin-top:6px;" onchange="saveState(); appData['${date}'][${s.originalIdx}].trainer=this.value; saveToStorage();"><option value="">-Trainer-</option>${trOptions}</select>` : '';
            item.innerHTML = `<div class="line-1"><b>${s.name}${isT?' (T)':''}</b><div onclick="deleteShift('${date}', ${s.originalIdx})" class="delete-btn">×</div></div><div class="line-2">${s.label} (${s.durHours}h)</div><div class="chk-group"><label class="chk-container"><input type="checkbox" ${s.inactive?'checked':''} onchange="toggleInactive('${date}', ${s.originalIdx})">Inactive</label>${isT?`<label class="chk-container"><input type="checkbox" ${s.isStaffing?'checked':''} onchange="toggleStaffing('${date}', ${s.originalIdx})">Staffing</label>`:''}</div>${dd}${tags}`;
            rosterBox.appendChild(item);
        });

        let graphOrder = []; let claimedIdx = new Set();
        let baseList = [...sidebarSorted];
        if (activePreviewIdx !== null) {
            const req = appData[date][activePreviewIdx];
            if (req && req.isShiftChg) {
                const clean = req.to.replace(/[:\-10]/g,'').substring(0,4);
                baseList.push({ name: req.name, start: getMinutesFrom0400(parseInt(clean.substring(0,2)), parseInt(clean.substring(2,4))), duration: req.calcDur*60, durHours: req.calcDur, isGhost: true, label: `${req.to} PROPOSED` });
            }
        }
        baseList.sort((a,b) => a.start - b.start).forEach(item => {
            if (claimedIdx.has(item.originalIdx) && !item.isGhost) return;
            graphOrder.push(item); if(!item.isGhost) claimedIdx.add(item.originalIdx);
            sidebarSorted.forEach(other => { if (other.trainer === item.name) { graphOrder.push(other); claimedIdx.add(other.originalIdx); } });
        });

        graphOrder.forEach(item => {
            const isT = traineeList.includes(item.name);
            const pairedTrainee = approved.find(t => t.trainer === item.name && !t.isStaffing);
            renderBar(item, gridBody, isT, (pairedTrainee && !isT) ? { start: pairedTrainee.start, end: pairedTrainee.start + pairedTrainee.duration } : null);
        });

        pending.forEach(req => {
            const item = document.createElement('div'); item.className = 'request-item';
            const statusClass = req.status === "Pending" ? "tag-pending" : "tag-denied";
            item.innerHTML = `<div class="req-info">${req.name}: ${req.type}${req.calcDur!==8?` (${req.calcDur}h)` : ""}<br>from ${req.from} to ${req.to} <span class="req-status-tag ${statusClass}">${req.status}</span></div><div class="req-buttons"><button class="btn-preview ${activePreviewIdx===req.originalIdx?'active':''}" onclick="togglePreview(${req.originalIdx})">Preview</button><button onclick="commitPending(${req.originalIdx})">Commit</button></div>`;
            inbox.appendChild(item);
        });

        for(let i=0; i<24; i++) {
            const box = document.getElementById(`hour-count-${i}`), h = (i + 4) % 24, val = counts[i];
            box.innerText = val; box.className = "";
            if (h === 6 || h === 20 || h === 21 || h === 22) { let tgt = (h===6?4 : h===20?8 : h===21?5 : 3); if (val >= tgt) box.className='count-success'; else box.className='count-danger'; }
            else if (h >= 8 && h < 20) { if (val <= 5) box.className='count-danger'; else if (val === 6) box.className='count-warning'; }
        }
    }

    function renderBar(s, container, isT, tWin) {
        let bS = s.start, bE = s.start + s.duration;
        if (s.xte) { bS = Math.min(bS, s.xte.start); bE = Math.max(bE, Math.min(s.xte.end, 1440)); }
        let totalW = bE - bS; if (totalW <= 0) return;
        const track = document.createElement('div'); track.className = 'shift-track';
        const bar = document.createElement('div'); 
        bar.className = 'shift-bar' + (s.inactive?' bar-inactive':'') + (isT && !s.isStaffing ? ' bar-trainee' : '');
        if (s.isGhost) bar.classList.add('preview-glow');
        if (activePreviewIdx !== null) {
            const req = appData[document.getElementById('date-picker').value][activePreviewIdx];
            if (req && req.isShiftChg && s.name === req.name && !s.isGhost) bar.classList.add('preview-greyout');
        }
        bar.style.gridColumn = `${bS + 1} / span ${totalW}`;
        let blueS = s.start, blueE = s.start + s.duration;
        if(s.leave) { if(s.leave.start <= blueS) blueS = s.leave.end; else blueE = s.leave.start; }
        const textWrapper = document.createElement('div'); textWrapper.className = 'bar-text-wrapper';
        textWrapper.style.left = ((blueS - bS)/totalW*100) + "%"; textWrapper.style.width = ((blueE - blueS)/totalW*100) + "%";
        textWrapper.innerHTML = `<span>${s.name} (${s.label}) (${s.durHours}h)</span>`;
        bar.appendChild(textWrapper);

        if (tWin && !s.inactive) {
            const stripe = document.createElement('div'); stripe.className = 'overlay-segment trainer-stripes-overlay';
            let sO = Math.max(s.start, tWin.start), eO = Math.min((s.start + s.duration), tWin.end);
            if (eO > sO) { stripe.style.left = ((sO - bS) / totalW * 100) + "%"; stripe.style.width = ((Math.min(eO, Math.min(s.start + s.duration - 60, 1440)) - sO) / totalW * 100) + "%"; bar.appendChild(stripe); }
        }
        if (!s.inactive && (s.durHours >= 8) && (!isT || s.isStaffing) && !s.isGhost) {
            const yellow = document.createElement('div'); yellow.className = 'overlay-segment yellow-bar-overlay';
            yellow.style.right = "0"; yellow.style.width = (60 / totalW * 100) + "%"; bar.appendChild(yellow);
        }
        if (s.leave) { 
            const l = document.createElement('div'); l.className = 'overlay-segment leave-segment'; 
            l.style.left = ((s.leave.start - bS)/totalW*100) + "%"; l.style.width = ((s.leave.end - s.leave.start)/totalW*100) + "%"; 
            l.innerHTML = `<span class="segment-label">LV</span>`; bar.appendChild(l); 
        }
        if (activePreviewIdx !== null) {
            const req = appData[document.getElementById('date-picker').value][activePreviewIdx];
            if (req && !req.isShiftChg && s.name === req.name && !s.isGhost) {
                const f = req.from.replace(/[:\-]/g,'').substring(0,4), t = req.to.replace(/[:\-]/g,'').substring(0,4);
                const ps = document.createElement('div'); ps.className = 'overlay-segment leave-segment preview-glow';
                ps.style.left = ((getMinutesFrom0400(parseInt(f.substring(0,2)), parseInt(f.substring(2,4))) - bS)/totalW*100) + "%"; 
                ps.style.width = ((getMinutesFrom0400(parseInt(t.substring(0,2)), parseInt(t.substring(2,4))) - getMinutesFrom0400(parseInt(f.substring(0,2)), parseInt(f.substring(2,4))))/totalW*100) + "%";
                ps.innerHTML = `<span class="segment-label">PREVIEW</span>`; bar.appendChild(ps);
            }
        }
        if (s.xte) {
            const x = document.createElement('div'); x.className = 'overlay-segment xte-segment'; 
            x.style.left = ((s.xte.start - bS)/totalW*100) + "%"; x.style.width = ((s.xte.end - s.xte.start)/totalW*100) + "%"; 
            x.innerHTML = `<span class="segment-label">XTE</span>`; bar.appendChild(x); 
        }
        track.appendChild(bar); container.appendChild(track);
    }

    function toggleInactive(d, i) { saveState(); appData[d][i].inactive = !appData[d][i].inactive; saveToStorage(); }
    function toggleStaffing(d, i) { saveState(); appData[d][i].isStaffing = !appData[d][i].isStaffing; saveToStorage(); }
    function deleteShift(d, i) { if(confirm("Delete shift?")) { saveState(); appData[d].splice(i, 1); saveToStorage(); } }
    function clearAllShifts() { if(confirm("Clear ALL data?")) { saveState(); appData = {}; saveToStorage(); } }

    function init() {
        document.getElementById('date-picker').value = new Date().toISOString().split('T')[0];
        document.getElementById('date-picker').onchange = () => render(document.getElementById('date-picker').value);
        const tl = document.getElementById('time-labels-inner'), cc = document.getElementById('coverage-counts-inner');
        for (let i = 0; i < 24; i++) {
            const hr = (i + 4) % 24;
            const ts = document.createElement('span'); ts.innerText = hr !== 4 ? `${hr.toString().padStart(2, '0')}:00` : "";
            tl.appendChild(ts);
            const cs = document.createElement('span'); cs.id = `hour-count-${i}`; cs.innerText = '0';
            cc.appendChild(cs);
        }
        render(document.getElementById('date-picker').value);
    }
    init();
</script>

<div id="trainerListModal" class="modal"><div class="modal-content"><h3>Trainers</h3><textarea id="trainerListInput"></textarea><div class="modal-footer"><button style="background:#94a3b8" onclick="closeModal('trainerListModal')">Cancel</button><button onclick="trainersList=document.getElementById('trainerListInput').value.split('\n');localStorage.setItem('roster_trainers_list', JSON.stringify(trainersList));saveToStorage();closeModal('trainerListModal')">Apply</button></div></div></div>
<div id="traineeModal" class="modal"><div class="modal-content"><h3>Trainees</h3><textarea id="traineeInput"></textarea><div class="modal-footer"><button style="background:#94a3b8" onclick="closeModal('traineeModal')">Cancel</button><button onclick="traineeList=document.getElementById('traineeInput').value.split('\n');localStorage.setItem('roster_trainees', JSON.stringify(traineeList));saveToStorage();closeModal('traineeModal')">Apply</button></div></div></div>
<div id="rosterModal" class="modal"><div class="modal-content"><h3>Add Schedule</h3><textarea id="rosterInput"></textarea><div class="modal-footer"><button style="background:#94a3b8" onclick="closeModal('rosterModal')">Cancel</button><button onclick="processRoster()">Apply</button></div></div></div>
<div id="manualModal" class="modal"><div class="modal-content"><h3>Manual Entry</h3><input type="text" id="manualIni" placeholder="Ini"><input type="text" id="manualTime" placeholder="hhmm"><input type="number" id="manualDur" value="8"><div class="modal-footer"><button style="background:#94a3b8" onclick="closeModal('manualModal')">Cancel</button><button onclick="addManualShift()">Add</button></div></div></div>
<div id="requestModal" class="modal">
    <div class="modal-content">
        <h3>Add Requests</h3><textarea id="requestInput"></textarea>
        <div id="debugTableContainer"><table class="debug-table"><thead><tr><th>Ini</th><th>Type</th><th>From</th><th>To</th><th>Status</th></tr></thead><tbody id="debugTableBody"></tbody></table></div>
        <div class="modal-footer"><button style="background:#94a3b8" onclick="closeModal('requestModal')">Cancel</button><button id="verifyReqBtn" onclick="verifyRequests()">Verify</button><button id="saveReqBtn" style="display:none; background:#10b981;" onclick="applyRequests()">Save</button></div>
    </div>
</div>

</body>
</html>
