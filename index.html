<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Visualizer</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --panel-bg: #ffffff;
            --text-color: #333;
            --accent-color: #3b82f6;
            --grid-line-color: #e5e7eb;
            --bar-color: #60a5fa;      /* Standard Blue */
            --bar-trainee: #a855f7;    /* Trainee Purple */
            --bar-hover: #2563eb;
            --danger-color: #ef4444;
            --last-hour-color: #fcd34d; /* Yellow */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

        body {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            padding: 10px 20px;
            background: var(--panel-bg);
            border-bottom: 1px solid #ccc;
            display: flex;
            align-items: center;
            gap: 15px;
            height: 60px;
            flex-shrink: 0;
        }

        h2 { font-size: 1.2rem; margin-right: auto; }

        input[type="date"] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }

        button {
            padding: 6px 12px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        button:hover { opacity: 0.9; }
        button.secondary { background-color: #6b7280; }

        /* --- Main Layout --- */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            height: calc(100vh - 60px);
        }

        /* --- Graph Section (Left) --- */
        .graph-container {
            flex: 1; 
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ccc;
            position: relative;
            overflow: hidden;
            background: #fff;
        }

        .timeline-header {
            height: 40px;
            position: relative;
            border-bottom: 1px solid #ccc;
            background: #f9fafb;
            flex-shrink: 0;
        }

        .time-label {
            position: absolute;
            bottom: 5px;
            font-size: 0.75rem;
            transform: translateX(-50%);
            color: #666;
        }

        .graph-body {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
            overflow-y: hidden; 
        }

        .grid-lines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
        }
        .grid-line {
            position: absolute;
            top: 0; bottom: 0;
            width: 1px;
            background-color: var(--grid-line-color);
        }

        /* Current Time Line */
        .current-time-line {
            position: absolute;
            top: 0; bottom: 0;
            width: 2px;
            background-color: var(--danger-color);
            z-index: 50;
            pointer-events: none;
            box-shadow: 0 0 4px rgba(239, 68, 68, 0.6);
        }
        .current-time-line::after {
            content: "NOW";
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 0.65rem;
            background: var(--danger-color);
            color: white;
            padding: 1px 3px;
            border-radius: 2px;
        }

        /* Shift Rows */
        .shift-row {
            position: relative;
            width: 100%;
            flex: 1; 
            min-height: 0;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f3f4f6; 
        }

        .shift-bar {
            position: absolute;
            height: 70%; 
            background-color: var(--bar-color);
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 5px;
            cursor: pointer;
            z-index: 5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .shift-bar:hover {
            background-color: var(--bar-hover);
            z-index: 10;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            height: 85%;
        }
        .shift-bar.trainee { background-color: var(--bar-trainee); border-color: #7e22ce; }

        /* Yellow Bar for Last Hour */
        .last-hour-indicator {
            position: absolute;
            top: 0; bottom: 0; right: 0;
            background-color: var(--last-hour-color);
            opacity: 0.6;
            z-index: 6;
            pointer-events: none;
            border-left: 1px solid rgba(0,0,0,0.1);
        }
        .bar-text { position: relative; z-index: 7; font-weight: 500; }

        /* --- List Section (Right) --- */
        .list-container {
            width: 250px;
            min-width: 250px;
            max-width: 300px;
            background: var(--panel-bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-left: 1px solid #ccc;
        }

        .list-header {
            padding: 10px;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            background: #f3f4f6;
            font-size: 0.9rem;
        }

        .employee-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .employee-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 6px;
            background: #fff;
            transition: background 0.2s;
        }
        .employee-card.trainee-card { background-color: #f3e8ff; border-color: #d8b4fe; }
        .employee-card:hover { background-color: #f9fafb; }
        
        .emp-info { display: flex; flex-direction: column; overflow: hidden; width: 50%; }
        .emp-name { font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .emp-time { font-size: 0.75rem; color: #666; }
        .cic-tag { font-size: 0.65rem; color: #d97706; font-weight: bold; margin-left: 5px; background: #fef3c7; padding: 1px 3px; border-radius: 3px; }

        .emp-actions { display: flex; gap: 3px; }
        .btn-icon { padding: 4px 8px; font-size: 0.75rem; margin-left: 2px; border-radius: 3px; border:none; color:white; cursor:pointer;}
        .btn-edit { background-color: #f59e0b; }
        .btn-del { background-color: var(--danger-color); }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .modal h3 { margin-bottom: 15px; }
        .modal textarea { width: 100%; height: 150px; margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; font-family: monospace; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 0.85rem; margin-bottom: 4px; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }

    </style>
</head>
<body>

<header>
    <h2>Shift Visualizer</h2>
    <input type="date" id="datePicker">
    <button onclick="openPasteModal()">+ Paste Data</button>
    <button class="secondary" onclick="clearData()">Clear Day</button>
</header>

<div class="main-container">
    <div class="graph-container">
        <div class="timeline-header" id="timelineHeader"></div>
        <div class="grid-lines" id="gridLines"></div>
        <div id="currentTimeLine" class="current-time-line" style="display:none;"></div>
        <div class="graph-body" id="graphBody"></div>
    </div>

    <div class="list-container">
        <div class="list-header">Employee List</div>
        <div class="employee-list" id="employeeList"></div>
    </div>
</div>

<div class="modal-overlay" id="pasteModal">
    <div class="modal">
        <h3>Paste Schedule Data</h3>
        <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">Paste column data below.</p>
        <textarea id="pasteInput" placeholder="Paste data here..."></textarea>
        <div class="modal-actions">
            <button class="secondary" onclick="closeModal('pasteModal')">Cancel</button>
            <button onclick="processPaste()">Visualize</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="editModal">
    <div class="modal">
        <h3>Edit Shift</h3>
        <input type="hidden" id="editId">
        <div class="form-group"><label>Name</label><input type="text" id="editName"></div>
        <div class="form-group">
            <label>Type</label>
            <select id="editType"><option value="standard">Standard</option><option value="trainee">Trainee</option></select>
        </div>
        <div class="form-group"><label>Start</label><input type="time" id="editStart"></div>
        <div class="form-group"><label>End</label><input type="time" id="editEnd"></div>
        <div class="form-group"><label>Notes</label><input type="text" id="editNotes"></div>
        <div class="modal-actions">
            <button class="secondary" onclick="closeModal('editModal')">Cancel</button>
            <button onclick="saveEdit()">Save</button>
        </div>
    </div>
</div>

<script>
    const START_HOUR = 4; // 04:00 Start
    const TOTAL_MINUTES = 24 * 60; 
    let currentDate = new Date().toISOString().split('T')[0];
    let shifts = [];

    document.addEventListener('DOMContentLoaded', () => {
        const dateInput = document.getElementById('datePicker');
        dateInput.value = currentDate;
        dateInput.addEventListener('change', (e) => {
            currentDate = e.target.value;
            loadData();
        });

        generateTimeline();
        loadData();
        
        updateCurrentTime();
        setInterval(updateCurrentTime, 60000);
    });

    // --- TIMELINE & CLOCK ---
    function generateTimeline() {
        const header = document.getElementById('timelineHeader');
        const grid = document.getElementById('gridLines');
        header.innerHTML = ''; grid.innerHTML = '';

        for (let i = 0; i <= 24; i++) {
            let hour = START_HOUR + i;
            let displayHour = hour % 24; 
            let labelText = String(displayHour).padStart(2, '0') + ":00";
            let pct = (i / 24) * 100;

            if (i < 24) { 
                const line = document.createElement('div');
                line.className = 'grid-line';
                line.style.left = pct + '%';
                grid.appendChild(line);
            }
            const label = document.createElement('div');
            label.className = 'time-label';
            label.innerText = labelText;
            label.style.left = pct + '%';
            header.appendChild(label);
        }
    }

    function updateCurrentTime() {
        const now = new Date();
        const line = document.getElementById('currentTimeLine');
        let h = now.getHours();
        let m = now.getMinutes();
        let minutesFromMidnight = (h * 60) + m;
        let startOfDayMinutes = START_HOUR * 60;
        let rel = minutesFromMidnight - startOfDayMinutes;
        if (rel < 0) rel += (24 * 60);

        if (rel >= 0 && rel <= TOTAL_MINUTES) {
            let pct = (rel / TOTAL_MINUTES) * 100;
            line.style.left = pct + '%';
            line.style.display = 'block';
        } else {
            line.style.display = 'none';
        }
    }

    // --- RENDER ---
    function timeToOffset(timeStr) {
        let clean = timeStr.replace(':', '');
        let h = parseInt(clean.substring(0, 2));
        let m = parseInt(clean.substring(2, 4));
        let mins = (h * 60) + m;
        let startMins = START_HOUR * 60;
        let rel = mins - startMins;
        if (rel < 0) rel += (24 * 60);
        return rel;
    }

    function render() {
        const graphBody = document.getElementById('graphBody');
        const listBody = document.getElementById('employeeList');
        graphBody.innerHTML = ''; listBody.innerHTML = '';

        shifts.forEach((shift, index) => {
            const startOffset = timeToOffset(shift.start);
            const endOffset = timeToOffset(shift.end);
            let duration = endOffset - startOffset;
            if (duration < 0) duration += (24 * 60); 

            // Calculate Duration in Hours
            let durationHours = (duration / 60).toFixed(1).replace('.0', '');

            const leftPct = (startOffset / TOTAL_MINUTES) * 100;
            const widthPct = (duration / TOTAL_MINUTES) * 100;
            
            // Yellow Bar (Last 60 mins)
            let yellowWidthPct = 0;
            if (duration > 0) {
                let lastHourMins = Math.min(60, duration);
                yellowWidthPct = (lastHourMins / duration) * 100;
            }

            const isTrainee = shift.type === 'trainee';

            // --- Graph Row ---
            const row = document.createElement('div');
            row.className = 'shift-row';
            
            const bar = document.createElement('div');
            bar.className = `shift-bar ${isTrainee ? 'trainee' : ''}`;
            bar.style.left = `${leftPct}%`;
            bar.style.width = `${widthPct}%`;
            bar.onclick = () => openEditModal(index);
            bar.title = `${shift.name}: ${shift.start} - ${shift.end} (${durationHours}h)`;

            let displayName = shift.name;
            if (shift.isCic) displayName += " (CIC)";
            if (shift.notes) displayName += ` [${shift.notes}]`;
            
            // Add Time and Duration to Label
            let label = `${displayName} (${shift.start}-${shift.end}, ${durationHours}h)`;

            bar.innerHTML = `
                <span class="bar-text">${label}</span>
                <div class="last-hour-indicator" style="width: ${yellowWidthPct}%;"></div>
            `;

            row.appendChild(bar);
            graphBody.appendChild(row);

            // --- List Item ---
            const card = document.createElement('div');
            card.className = `employee-card ${isTrainee ? 'trainee-card' : ''}`;
            card.innerHTML = `
                <div class="emp-info">
                    <div class="emp-name">
                        ${shift.name} 
                        ${shift.isCic ? '<span class="cic-tag">CIC</span>' : ''}
                    </div>
                    <div class="emp-time">${shift.start} - ${shift.end} (${durationHours}h)</div>
                </div>
                <div class="emp-actions">
                    <button class="btn-icon btn-edit" onclick="openEditModal(${index})">Edit</button>
                    <button class="btn-icon btn-del" onclick="deleteShift(${index})">X</button>
                </div>
            `;
            listBody.appendChild(card);
        });
    }

    // --- DATA ---
    function loadData() {
        const stored = localStorage.getItem('shifts_' + currentDate);
        shifts = stored ? JSON.parse(stored) : [];
        render();
    }
    function saveData() { localStorage.setItem('shifts_' + currentDate, JSON.stringify(shifts)); render(); }
    function deleteShift(index) { if(confirm('Delete?')) { shifts.splice(index, 1); saveData(); } }
    function clearData() { if(confirm('Clear all?')) { shifts = []; saveData(); } }

    // --- PARSER ---
    function processPaste() {
        let text = document.getElementById('pasteInput').value;
        text = text.replace(/(\d+\s+of\s+\d+)(\d{3,4})/g, "$1\n$2"); 
        let lines = text.split(/\n+/).map(l => l.trim()).filter(l => l);

        let currentShift = null;
        let dataBuffer = []; 
        const shiftRegex = /^(\d{3,4})[fF]?(-(\d{1,2}))?$/;

        function processBuffer() {
            if (!currentShift) return;
            let cleanData = dataBuffer.filter(l => !l.includes(' of '));
            
            // Split by space/comma/tab to ensure distinct bars
            // Line 0: SUP
            if (cleanData[0]) {
                let names = cleanData[0].split(/[\s,\t]+/);
                names.forEach(n => {
                    if(!n) return;
                    let isCic = false;
                    let cleanName = n;
                    if (cleanName.includes('(') && cleanName.includes(')')) {
                        isCic = true;
                        cleanName = cleanName.replace(/[()]/g, '').trim();
                    }
                    addShift(cleanName, currentShift.start, currentShift.end, 'standard', isCic);
                });
            }
            // Line 1: CPC
            if (cleanData[1]) {
                cleanData[1].split(/[\s,\t]+/).forEach(n => { if(n) addShift(n, currentShift.start, currentShift.end, 'standard', false); });
            }
            // Line 2: DEV
            if (cleanData[2]) {
                cleanData[2].split(/[\s,\t]+/).forEach(n => { if(n) addShift(n, currentShift.start, currentShift.end, 'trainee', false); });
            }
        }

        lines.forEach(line => {
            const match = line.match(shiftRegex);
            if (match) {
                processBuffer();
                dataBuffer = [];
                let t = match[1].padStart(4, '0');
                let h = parseInt(t.substring(0, 2));
                let m = parseInt(t.substring(2, 4));
                let dur = match[3] ? parseInt(match[3]) : 8;
                let eH = (h + dur) % 24;
                currentShift = {
                    start: `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`,
                    end: `${String(eH).padStart(2,'0')}:${String(m).padStart(2,'0')}`
                };
            } else {
                dataBuffer.push(line);
            }
        });
        processBuffer();
        saveData();
        closeModal('pasteModal');
        document.getElementById('pasteInput').value = '';
    }

    function addShift(name, start, end, type, isCic) {
        if (!name) return;
        shifts.push({ name, start, end, type, isCic, notes: '' });
    }

    // --- MODALS ---
    function openPasteModal() { document.getElementById('pasteModal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function openEditModal(index) {
        const s = shifts[index];
        document.getElementById('editId').value = index;
        document.getElementById('editName').value = s.name;
        document.getElementById('editType').value = s.type || 'standard';
        document.getElementById('editStart').value = s.start;
        document.getElementById('editEnd').value = s.end;
        document.getElementById('editNotes').value = s.notes || '';
        document.getElementById('editModal').style.display = 'flex';
    }
    function saveEdit() {
        const idx = document.getElementById('editId').value;
        if (idx !== '') {
            shifts[idx] = {
                name: document.getElementById('editName').value,
                start: document.getElementById('editStart').value,
                end: document.getElementById('editEnd').value,
                type: document.getElementById('editType').value,
                isCic: shifts[idx].isCic,
                notes: document.getElementById('editNotes').value
            };
            saveData();
            closeModal('editModal');
        }
    }
    window.onclick = function(e) { if (e.target.classList.contains('modal-overlay')) e.target.style.display = "none"; }
</script>
</body>
</html>
